<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>A Gift of Time — Prayer Times, Islamic Prayer Clock, Qibla Compass & Spatial Adhan</title>
<meta name="description" content="A Gift of Time — a beautiful prayer clock for Muslims. Accurate prayer times, Qibla compass, spatial adhan toward Mecca, Ramadan fasting timer, and 11 dial designs named after Surahs. Free, no ads, no tracking — sadaqah jariyah.">
<meta name="keywords" content="A Gift of Time, prayer times, Islamic prayer times, prayer clock, Muslim prayer app, salah times, namaz times, Fajr time, Dhuhr time, Asr time, Maghrib time, Isha time, Qibla compass, Qibla direction, adhan notification, spatial adhan, Ramadan fasting clock, suhoor iftar timer, prayer reminder, Al-Fajr, Ash-Shams, Al-Asr, Al-Qadr, An-Nur, Al-Kawthar, Al-Mulk, Ar-Rahman, Al-Kahf, Ya-Sin, Al-Fatihah, Surah Yusuf, Islamic art, sadaqah jariyah, free Muslim app, agiftoftime">
<link rel="canonical" href="https://agiftoftime.app/">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://agiftoftime.app/">
<meta property="og:title" content="A Gift of Time — Prayer Times, Qibla Compass & Spatial Adhan">
<meta property="og:description" content="A Gift of Time — accurate prayer times, Qibla compass, spatial adhan toward Mecca, Ramadan fasting timer, and 11 Surah-named dials. Free, no ads — sadaqah jariyah.">
<meta property="og:image" content="https://agiftoftime.app/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="A Gift of Time prayer clock showing Arabic numerals, Qibla compass subdial, and prayer time indicators">
<meta property="og:site_name" content="A Gift of Time">
<meta property="og:locale" content="en_US">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="A Gift of Time — Prayer Times & Islamic Prayer Clock">
<meta name="twitter:description" content="A Gift of Time — prayer times, Qibla compass, spatial adhan toward Mecca, fasting timer. 11 dials named after Surahs. Free, no ads — sadaqah jariyah.">
<meta name="twitter:image" content="https://agiftoftime.app/og-image.png">
<meta name="twitter:image:alt" content="A Gift of Time prayer clock with Arabic numerals and Qibla compass">

<!-- Additional SEO -->
<meta name="author" content="Tawfeeq Martin">
<meta name="theme-color" content="#f8f7f4">
<meta name="apple-mobile-web-app-title" content="A Gift of Time">
<meta name="application-name" content="A Gift of Time">
<link rel="apple-touch-icon" href="https://agiftoftime.app/apple-touch-icon.png">

<!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "A Gift of Time",
  "url": "https://agiftoftime.app",
  "description": "A beautiful Three.js prayer clock for Muslims with accurate prayer times, Qibla compass, HRTF spatial adhan toward Mecca, Ramadan fasting tracker, and 11 dial designs named after Surahs of the Quran.",
  "applicationCategory": "LifestyleApplication",
  "operatingSystem": "Any",
  "browserRequirements": "Requires WebGL support",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  },
  "author": {
    "@type": "Person",
    "name": "Tawfeeq Martin",
    "url": "https://tawfeeqmartin.com"
  },
  "featureList": [
    "Accurate Islamic prayer times based on location",
    "Qibla compass with real-time direction to Mecca",
    "HRTF spatial adhan — sound from the direction of Qibla",
    "Ramadan fasting progress tracker (Suhoor to Iftar)",
    "11 dial designs named after Surahs of the Quran",
    "Night mode with SuperLuminova lume glow",
    "Tawaf animation at Maghrib",
    "Works offline as a Progressive Web App",
    "Three.js GPU-rendered with PBR materials and HDRI reflections",
    "No ads, no tracking — completely free"
  ],
  "screenshot": "https://agiftoftime.app/og-image.png",
  "inLanguage": "en",
  "isAccessibleForFree": true
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "What is A Gift of Time?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "A Gift of Time is a free Islamic prayer clock web app with accurate prayer times, Qibla compass, spatial adhan toward Mecca, fasting tracker, and 11 beautiful dial designs named after Surahs of the Quran. Built with Three.js and WebGL."
      }
    },
    {
      "@type": "Question",
      "name": "How does the spatial adhan work?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "The adhan audio is spatialized using the Web Audio API so the sound appears to come from the direction of Qibla (Mecca). When you turn your phone, the adhan shifts direction — best experienced with headphones."
      }
    },
    {
      "@type": "Question",
      "name": "Is A Gift of Time free?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes, completely free with no ads and no tracking. It is built as a sadaqah jariyah (ongoing charity) for the Muslim community."
      }
    },
    {
      "@type": "Question",
      "name": "How do I install it on my phone?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Open the clock in your mobile browser, tap Share, then select Add to Home Screen. It works offline as a Progressive Web App."
      }
    },
    {
      "@type": "Question",
      "name": "What are the 11 dial designs?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Each dial is named after a Surah of the Quran: Al-Fajr, Ash-Shams, Al-Asr, Al-Qadr, An-Nur, Al-Kawthar, Al-Mulk, Ar-Rahman, Al-Kahf, Ya-Sin, and Al-Fatihah. Inspired by Surah Yusuf 12:4 — eleven stars."
      }
    }
  ]
}
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&family=Lateef:wght@400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/thin/style.css">
<script type="importmap">
{"imports":{"three":"https://esm.sh/three@0.170.0","three/addons/":"https://esm.sh/three@0.170.0/examples/jsm/"}}
</script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f8f7f4;
  --fg:#1a1a1a;
  --dim:rgba(26,26,26,.55);
  --muted:rgba(26,26,26,.3);
  --accent:#c8a44e;
  --border:rgba(26,26,26,.08);
  --card-bg:rgba(26,26,26,.03);
  --font:'Inter',system-ui,-apple-system,sans-serif;
  --clock-size:min(480px,85vw);
  --ease:cubic-bezier(.4,0,.2,1);
}
html{font-size:16px}
body{
  font-family:var(--font);background:var(--bg);color:var(--fg);
  font-weight:300;line-height:1.7;-webkit-font-smoothing:antialiased;
  overflow-x:clip;width:100%;
  transition:background 1s var(--ease),color 1s var(--ease);
}

/* ── Sticky clock ── */
.clock-sticky{
  position:sticky;top:0;z-index:50;
  display:flex;align-items:center;justify-content:center;
  height:calc(var(--clock-size) + 4.5rem);
  padding:4rem 0 .5rem;
  background:var(--bg);
  transition:background 1s var(--ease);
}
#dialHero{
  width:var(--clock-size);height:var(--clock-size);
  border-radius:50%;overflow:hidden;
  background:#585860;
  flex-shrink:0;
  transition:box-shadow 1.5s var(--ease);
}

/* ── Nav ── */
nav{
  position:fixed;top:0;left:0;right:0;z-index:100;
  padding:.75rem clamp(24px,5vw,64px);
  display:flex;align-items:center;justify-content:space-between;
  transition:background .3s var(--ease),box-shadow .3s var(--ease);
}
nav.scrolled{background:var(--bg);opacity:.97;backdrop-filter:blur(12px);box-shadow:0 1px 0 var(--border)}
.nav-logo{font-weight:500;font-size:clamp(.65rem,.9vw,.8rem);letter-spacing:.15em;text-transform:uppercase}

/* ── Buttons ── */
.btn{
  display:inline-flex;align-items:center;gap:.5rem;
  padding:14px 32px;border-radius:12px;
  font-family:var(--font);font-size:.95rem;font-weight:500;
  cursor:pointer;border:none;transition:all .3s var(--ease);
  text-decoration:none;
}
.btn-primary{background:var(--fg);color:var(--bg)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,.15)}
.btn-outline{
  background:transparent;border:1px solid var(--border);color:var(--fg);
  padding:12px 24px;font-size:.9rem;
}
.btn-outline:hover{border-color:var(--fg)}
.btn-sm{padding:10px 20px;font-size:.85rem}
a{color:inherit;text-decoration:none}

/* ── Sections ── */
.scroll-section{
  min-height:80vh;
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  text-align:center;
  padding:0 clamp(24px,5vw,64px) clamp(100px,15vh,180px);
  position:relative;
  max-width:1200px;margin:0 auto;
  transition:background 1s var(--ease),color 1s var(--ease);
}
.section-label{
  font-weight:500;font-size:clamp(.65rem,.9vw,.8rem);letter-spacing:.15em;
  text-transform:uppercase;color:var(--accent);margin-bottom:1.5rem;
}
.section-title{
  font-weight:200;font-size:clamp(2rem,4vw,3.5rem);
  line-height:1.1;letter-spacing:-.02em;margin-bottom:1.5rem;
  transition:color 1s var(--ease);
}
.section-body{
  font-weight:300;font-size:clamp(.95rem,1.3vw,1.15rem);line-height:1.7;
  color:var(--dim);max-width:480px;margin:0 auto;
  transition:color 1s var(--ease);
}

/* ── Quran verse block ── */
.verse{text-align:center;margin-top:3rem;max-width:560px}
.verse-ar{
  font-family:'Lateef','Traditional Arabic',serif;
  font-size:clamp(1.5rem,3.5vw,2.2rem);line-height:2;
  direction:rtl;color:var(--fg);margin-bottom:1rem;
  transition:color 1s var(--ease);
}
.verse-en{
  font-size:clamp(.95rem,1.3vw,1.15rem);font-weight:300;color:var(--dim);
  font-style:italic;line-height:1.7;margin-bottom:.5rem;
  transition:color 1s var(--ease);
}
.verse-ref{
  font-size:clamp(.65rem,.9vw,.8rem);font-weight:500;letter-spacing:.15em;
  text-transform:uppercase;color:var(--muted);margin-bottom:1.25rem;
  transition:color 1s var(--ease);
}

/* ── Reveal animation ── */
.reveal{opacity:0;transform:translateY(40px);transition:opacity .8s var(--ease),transform .8s var(--ease)}
.reveal.visible{opacity:1;transform:none}
@media(prefers-reduced-motion:reduce){.reveal{opacity:1;transform:none;transition:none}}

/* ── Prayer card ── */
#prayerCard{
  width:100%;max-width:360px;
  background:var(--card-bg);border:1px solid var(--border);
  border-radius:16px;
  padding:28px;display:flex;flex-direction:column;gap:.5rem;
  font-family:var(--font);margin-top:2.5rem;
  transition:background 1s var(--ease),border-color 1s var(--ease),color 1s var(--ease);
}

/* ── Dial picker ── */
.dial-dots{display:flex;gap:6px;justify-content:center;margin-top:1rem;flex-wrap:wrap}
.dial-dot{
  width:8px;height:8px;border-radius:50%;border:none;
  cursor:pointer;padding:0;transition:opacity .3s var(--ease),transform .3s var(--ease);
  opacity:.2;background:var(--fg);
}
.dial-dot.active{opacity:.7;transform:scale(1.3)}

/* ── Install steps ── */
.steps{display:flex;gap:3rem;margin-top:3rem;justify-content:center;flex-wrap:wrap;max-width:100%}
.step{text-align:center;min-width:0;width:200px;flex-shrink:1}
.step-icon{font-size:2rem;color:var(--muted);margin-bottom:1rem;transition:color 1s var(--ease)}
.step-num{font-weight:500;font-size:clamp(.65rem,.9vw,.8rem);letter-spacing:.15em;text-transform:uppercase;color:var(--accent);margin-bottom:.5rem}
.step h3{font-weight:400;font-size:clamp(.95rem,1.3vw,1.15rem);margin-bottom:.4rem;transition:color 1s var(--ease)}
.step p{font-weight:300;font-size:.85rem;color:var(--dim);line-height:1.7;transition:color 1s var(--ease)}

/* ── Scroll Snap ── */
html{scroll-snap-type:y mandatory;scroll-padding-top:calc(var(--clock-size) + 4.5rem)}
.scroll-section{scroll-snap-align:start}

/* ── Footer ── */
footer{
  padding:clamp(48px,8vh,80px) clamp(24px,5vw,64px);
  text-align:center;border-top:1px solid var(--border);
  max-width:1200px;margin:0 auto;
  transition:border-color 1s var(--ease);
}
footer p{font-weight:300;font-size:.85rem;color:var(--dim);transition:color 1s var(--ease)}
footer a{transition:color .3s var(--ease)}
footer a:hover{color:var(--fg)}
.footer-sep{margin:0 .75rem;opacity:.3}

/* ── Adhan button ── */
.adhan-btn{
  margin-top:2rem;padding:14px 32px;font-size:.95rem;gap:.75rem;
}

@media(max-width:768px){
  .scroll-section{padding-left:1.5rem;padding-right:1.5rem;min-height:60vh}
}
@media(min-width:769px){
  :root{--clock-size:min(500px,45vw)}
  .section-body{max-width:520px}
}
@media(min-width:1200px){
  :root{--clock-size:min(560px,35vw)}
}
</style>
</head>
<body>

<!-- Nav -->
<nav>
  <div class="nav-logo">A Gift of Time</div>
  <a href="https://agiftoftime.app/index-threejs.html" class="btn btn-primary btn-sm">Open Clock</a>
</nav>

<!-- Sticky Clock -->
<div class="clock-sticky">
  <div id="dialHero"></div>
</div>

<!-- 1. THE HOOK -->
<section class="scroll-section" id="sec-hook">
  <div class="reveal">
    <p class="section-label">Introducing</p>
    <h1 class="section-title" style="font-size:clamp(3rem,8vw,6rem);letter-spacing:-.03em">A Gift of Time.</h1>
    <p class="section-body">A prayer clock for your family. Rooted in the Quran, crafted with intention.</p>
    <a href="support.html" class="btn btn-outline" style="margin-top:2rem"><i class="ph-thin ph-heart"></i> Support this project</a>
  </div>
</section>

<!-- 2. QIBLA -->
<section class="scroll-section" id="sec-qibla">
  <div class="reveal">
    <p class="section-label">Direction</p>
    <h2 class="section-title">Always facing Qibla.</h2>
    <p class="section-body">The subdial compass points toward al-Masjid al-Haram. Turn your phone, and it follows.</p>
    <div class="verse">
      <p class="verse-ar">فَوَلِّ وَجْهَكَ شَطْرَ ٱلْمَسْجِدِ ٱلْحَرَامِ</p>
      <p class="verse-en">"So turn your face toward al-Masjid al-Haram."</p>
      <p class="verse-ref">Al-Baqarah 2:144</p>
      <button onclick="playVerse(this,'https://download.quranicaudio.com/qdc/mishari_al_afasy/murattal/2.mp3')" class="btn btn-outline btn-sm"><i class="ph-thin ph-play"></i> Listen</button>
    </div>
  </div>
</section>

<!-- 3. PRAYER TIMES -->
<section class="scroll-section" id="sec-prayer">
  <div class="reveal">
    <p class="section-label">Prayer Times</p>
    <h2 class="section-title">Every salah, on time.</h2>
    <p class="section-body">Accurate prayer times for your location. Fajr through Isha.</p>
    <div id="prayerCard">
      <p style="font-size:clamp(.65rem,.9vw,.8rem);font-weight:500;letter-spacing:.15em;text-transform:uppercase;color:var(--muted)" id="pcHijri">Loading...</p>
      <p style="font-size:.85rem;font-weight:300;color:var(--dim)" id="pcGreg"></p>
      <p style="font-size:clamp(.65rem,.9vw,.8rem);font-weight:400;color:var(--muted);margin-bottom:.25rem" id="pcLoc"></p>
      <div id="pcTimes" style="display:flex;flex-direction:column;gap:.4rem;width:100%"></div>
      <p style="font-size:.8rem;font-weight:300;color:var(--accent);margin-top:.25rem" id="pcNext"></p>
    </div>
    <div class="verse">
      <p class="verse-ar">إِنَّ ٱلصَّلَوٰةَ كَانَتْ عَلَى ٱلْمُؤْمِنِينَ كِتَـٰبًا مَّوْقُوتًا</p>
      <p class="verse-en">"Indeed, prayer has been decreed upon the believers at specified times."</p>
      <p class="verse-ref">An-Nisa 4:103</p>
      <button onclick="playVerse(this,'https://download.quranicaudio.com/qdc/mishari_al_afasy/murattal/4.mp3')" class="btn btn-outline btn-sm"><i class="ph-thin ph-play"></i> Listen</button>
    </div>
  </div>
</section>

<!-- 4. ELEVEN DIALS -->
<section class="scroll-section" id="sec-dials">
  <div class="reveal">
    <p class="section-label">Dial Themes</p>
    <h2 class="section-title">Eleven stars, eleven dials.</h2>
    <p class="section-body">Each named for a Surah. Chosen to inspire reflection on mercy, creation, and time.</p>
    <div style="margin-top:2rem;display:flex;align-items:center;gap:1.5rem">
      <button onclick="dialPrev()" aria-label="Previous dial" style="background:none;border:none;cursor:pointer;padding:.5rem"><i class="ph-thin ph-caret-left" style="font-size:1.5rem;color:var(--fg);opacity:.3"></i></button>
      <div style="text-align:center;min-width:200px">
        <span id="dialLabel" style="font-weight:400;font-size:.95rem;letter-spacing:.04em">Al-Layl</span>
        <div class="dial-dots" id="dialDots"></div>
      </div>
      <button onclick="dialNext()" aria-label="Next dial" style="background:none;border:none;cursor:pointer;padding:.5rem"><i class="ph-thin ph-caret-right" style="font-size:1.5rem;color:var(--fg);opacity:.3"></i></button>
    </div>
    <button id="dialListen" onclick="playDialSurah()" class="btn btn-outline btn-sm" style="margin-top:1.25rem"><i class="ph-thin ph-play"></i> Listen to this Surah</button>
    <div class="verse" style="margin-top:3rem">
      <p class="verse-ar">إِذْ قَالَ يُوسُفُ لِأَبِيهِ يَـٰٓأَبَتِ إِنِّىٓ رَأَيْتُ أَحَدَ عَشَرَ كَوْكَبًا وَٱلشَّمْسَ وَٱلْقَمَرَ رَأَيْتُهُمْ لِى سَـٰجِدِينَ</p>
      <p class="verse-en">"When Joseph said to his father, 'O my father, indeed I have seen eleven stars and the sun and the moon; I saw them prostrating to me.'"</p>
      <p class="verse-ref">Yusuf 12:4</p>
      <button onclick="playVerse(this,'https://download.quranicaudio.com/qdc/mishari_al_afasy/murattal/12.mp3')" class="btn btn-outline btn-sm"><i class="ph-thin ph-play"></i> Listen</button>
    </div>
  </div>
</section>

<!-- 5. NIGHT MODE -->
<section class="scroll-section" id="sec-night">
  <div class="reveal">
    <p class="section-label">Night Mode</p>
    <h2 class="section-title">The lume reveals itself.</h2>
    <p class="section-body">As darkness falls, SuperLuminova indices glow to life. Each dial carries its own lume colour.</p>
    <div class="verse">
      <p class="verse-ar">وَجَعَلَ ٱلظُّلُمَـٰتِ وَٱلنُّورَ</p>
      <p class="verse-en">"And He made darknesses and light."</p>
      <p class="verse-ref">Al-An'am 6:1</p>
      <button onclick="playVerse(this,'https://download.quranicaudio.com/qdc/mishari_al_afasy/murattal/6.mp3')" class="btn btn-outline btn-sm"><i class="ph-thin ph-play"></i> Listen</button>
    </div>
  </div>
</section>

<!-- 6. ADHAN -->
<section class="scroll-section" id="sec-adhan">
  <div class="reveal">
    <p class="section-label">Adhan</p>
    <h2 class="section-title">The call, from the direction of Mecca.</h2>
    <p class="section-body">Mishary Rashid al-Afasy. Spatialized toward Qibla.</p>
    <button id="adhanBtn" onclick="playAdhan(this)" class="btn btn-outline adhan-btn"><i class="ph-thin ph-play"></i> Play Spatial Adhan</button>
    <p style="font-size:.8rem;color:var(--muted);margin-top:1rem;font-weight:300">Best with headphones</p>
  </div>
</section>

<!-- 7. INSTALL -->
<section class="scroll-section" id="sec-install">
  <div class="reveal">
    <p class="section-label">Install</p>
    <h2 class="section-title">Add to home screen.</h2>
    <div class="steps">
      <div class="step">
        <i class="ph-thin ph-globe step-icon"></i>
        <p class="step-num">Step 1</p>
        <h3>Open</h3>
        <p>Visit the clock in your mobile browser.</p>
      </div>
      <div class="step">
        <i class="ph-thin ph-share-network step-icon"></i>
        <p class="step-num">Step 2</p>
        <h3>Share</h3>
        <p>Tap Share, then "Add to Home Screen."</p>
      </div>
      <div class="step">
        <i class="ph-thin ph-device-mobile step-icon"></i>
        <p class="step-num">Step 3</p>
        <h3>Launch</h3>
        <p>Opens full-screen. Works offline.</p>
      </div>
    </div>
    <a href="https://agiftoftime.app/index-threejs.html" class="btn btn-primary" style="margin-top:3rem">Open Clock</a>
  </div>
</section>

<!-- Footer -->
<footer>
  <p style="margin-bottom:.75rem">By <a href="https://tawfeeqmartin.com" target="_blank" rel="noopener">Tawfeeq Martin</a></p>
  <p><a href="support.html">Support</a><span class="footer-sep">&middot;</span><a href="mailto:feedback@agiftoftime.app">Feedback</a><span class="footer-sep">&middot;</span><a href="privacy.html">Privacy</a></p>
</footer>

<script>
// ══════════════════════════════════════════
// DIAL DATA
// ══════════════════════════════════════════
const DIALS=['tennis','white','salmon','slate','sky','kawthar','dhuha','najm','qamar','ward','lilas'];
const DIAL_NAMES={'tennis':'Ar-Raḥmān','white':'An-Nūr','salmon':'Ash-Shams','slate':'Al-Layl','sky':'Al-Burūj','kawthar':'Al-Kawthar','dhuha':'Aḍ-Ḍuḥā','najm':'An-Najm','qamar':'Al-Qamar','ward':'Al-Wāqiʿah','lilas':'Al-Mulk'};
const DIAL_COLORS={'tennis':'#68b890','white':'#e8e4dc','salmon':'#d8988c','slate':'#585860','sky':'#82b8d8','kawthar':'#f2dce0','dhuha':'#f08040','najm':'#384870','qamar':'#c0c4cc','ward':'#d89098','lilas':'#8878a8'};
const DIAL_LUMES={'tennis':'#88ff30','white':'#ffa0c0','salmon':'#ffc070','slate':'#c8e8a0','sky':'#80d0ff','kawthar':'#ffa0c0','dhuha':'#ffc040','najm':'#90b8ff','qamar':'#e8f0ff','ward':'#ff80a8','lilas':'#c090ff'};
const DIAL_SURAHS={'tennis':55,'white':24,'salmon':91,'slate':92,'sky':85,'kawthar':108,'dhuha':93,'najm':53,'qamar':54,'ward':56,'lilas':67};

let dialIdx=3; // slate default
let pageNight=false;
let dialAudio=null, dialPlaying=false;
let adhanAudio=null;
let dialCycleTimer=null;

// ══════════════════════════════════════════
// VERSE AUDIO HELPER
// ══════════════════════════════════════════
function playVerse(btn,url){
  if(!btn._a){
    btn._a=new Audio(url);
    btn._a.onended=()=>{btn.innerHTML='<i class="ph-thin ph-play"></i> Listen'};
  }
  if(btn._a.paused){btn._a.play();btn.innerHTML='<i class="ph-thin ph-pause"></i> Playing'}
  else{btn._a.pause();btn.innerHTML='<i class="ph-thin ph-play"></i> Listen'}
}

// ══════════════════════════════════════════
// DIAL CONTROLS
// ══════════════════════════════════════════
function buildDots(){
  const c=document.getElementById('dialDots');
  c.innerHTML=DIALS.map((_,i)=>`<button class="dial-dot${i===dialIdx?' active':''}" onclick="switchDial(${i})" style="background:${DIAL_COLORS[DIALS[i]]}" aria-label="${DIAL_NAMES[DIALS[i]]}"></button>`).join('');
}
function switchDial(i){
  dialIdx=i;
  updateDial();
}
function updateDial(){
  const d=DIALS[dialIdx];
  document.getElementById('dialLabel').textContent=DIAL_NAMES[d];
  document.querySelectorAll('.dial-dot').forEach((dot,i)=>{
    dot.classList.toggle('active',i===dialIdx);
  });
  if(dialAudio&&!dialAudio.paused){dialAudio.pause();dialPlaying=false;}
  document.getElementById('dialListen').innerHTML='<i class="ph-thin ph-play"></i> Listen to this Surah';
  if(window._clockSwitchDial) window._clockSwitchDial(d);
  updateLumeHalo();
}
function dialNext(){dialIdx=(dialIdx+1)%DIALS.length;updateDial();}
function dialPrev(){dialIdx=(dialIdx-1+DIALS.length)%DIALS.length;updateDial();}

function updateLumeHalo(){
  const hero=document.getElementById('dialHero');
  if(pageNight){
    const lume=DIAL_LUMES[DIALS[dialIdx]]||'#c8e8a0';
    hero.style.boxShadow='0 0 60px '+lume+'50, 0 0 120px '+lume+'25';
  }else{
    hero.style.boxShadow='none';
  }
}

function playDialSurah(){
  const num=DIAL_SURAHS[DIALS[dialIdx]];
  if(!num)return;
  const btn=document.getElementById('dialListen');
  if(dialPlaying&&dialAudio&&!dialAudio.paused){
    dialAudio.pause();dialPlaying=false;
    btn.innerHTML='<i class="ph-thin ph-play"></i> Listen to this Surah';return;
  }
  dialPlaying=true;
  dialAudio=new Audio('https://download.quranicaudio.com/qdc/mishari_al_afasy/murattal/'+num+'.mp3');
  dialAudio.onended=()=>{dialPlaying=false;btn.innerHTML='<i class="ph-thin ph-play"></i> Listen to this Surah'};
  dialAudio.play().catch(()=>{});
  btn.innerHTML='<i class="ph-thin ph-pause"></i> Playing — al-Afasy';
}

// ══════════════════════════════════════════
// NIGHT MODE
// ══════════════════════════════════════════
function setNightMode(on){
  if(pageNight===on)return;
  pageNight=on;
  const r=document.documentElement;
  if(on){
    r.style.setProperty('--bg','#0a0a0a');
    r.style.setProperty('--fg','#f5f5f0');
    r.style.setProperty('--dim','rgba(245,245,240,.5)');
    r.style.setProperty('--muted','rgba(245,245,240,.25)');
    r.style.setProperty('--border','rgba(255,255,255,.08)');
    r.style.setProperty('--card-bg','rgba(255,255,255,.04)');
  }else{
    r.style.setProperty('--bg','#f8f7f4');
    r.style.setProperty('--fg','#1a1a1a');
    r.style.setProperty('--dim','rgba(26,26,26,.55)');
    r.style.setProperty('--muted','rgba(26,26,26,.3)');
    r.style.setProperty('--border','rgba(26,26,26,.08)');
    r.style.setProperty('--card-bg','rgba(26,26,26,.03)');
  }
  document.querySelector('.clock-sticky').style.background=on?'#0a0a0a':'var(--bg)';
  const pc=document.getElementById('prayerCard');
  if(pc){pc.style.background=on?'rgba(255,255,255,.04)':'var(--card-bg)';pc.style.borderColor=on?'rgba(255,255,255,.08)':'var(--border)';}
  if(window._clockSetNight) window._clockSetNight(on);
  updateLumeHalo();
}

// ══════════════════════════════════════════
// SPATIAL ADHAN (HRTF toward Qibla)
// ══════════════════════════════════════════
let adhanCtx=null, adhanBufSrc=null, adhanPanner=null, adhanGain=null;
let adhanDecodedBuf=null, adhanInterval=null;
let adhanDeviceHeading=0, adhanQiblaAngle=0, adhanCurrentPan=0;
let adhanHasCompass=false;

async function adhanGetQibla(){
  try{
    const pos=await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j,{maximumAge:300000,timeout:5000}));
    const lat=pos.coords.latitude*Math.PI/180, lng=pos.coords.longitude*Math.PI/180;
    const mLat=21.4225*Math.PI/180, mLng=39.8262*Math.PI/180;
    adhanQiblaAngle=Math.atan2(Math.sin(mLng-lng),Math.cos(lat)*Math.tan(mLat)-Math.sin(lat)*Math.cos(mLng-lng));
  }catch(e){}
}

function adhanCompassHandler(e){
  const h=e.webkitCompassHeading||e.alpha;
  if(h==null)return;
  adhanHasCompass=true;
  adhanDeviceHeading=h*Math.PI/180;
}

function updateAdhanPan(){
  if(!adhanPanner||!adhanHasCompass)return;
  const ra=adhanQiblaAngle-adhanDeviceHeading;
  const target=Math.max(-1,Math.min(1,Math.sin(ra)));
  adhanCurrentPan+=(target-adhanCurrentPan)*0.15;
  adhanPanner.pan.value=adhanCurrentPan;
}

async function playAdhan(btn){
  if(adhanBufSrc){
    try{adhanBufSrc.stop();}catch(e){}
    adhanBufSrc=null;
    if(adhanInterval){clearInterval(adhanInterval);adhanInterval=null;}
    btn.innerHTML='<i class="ph-thin ph-play"></i> Play Spatial Adhan';
    return;
  }
  if(adhanAudio&&!adhanAudio.paused){adhanAudio.pause();adhanAudio=null;}

  btn.innerHTML='<i class="ph-thin ph-circle-notch"></i> Loading...';

  if(typeof DeviceOrientationEvent!=='undefined'&&DeviceOrientationEvent.requestPermission){
    try{await DeviceOrientationEvent.requestPermission();}catch(e){}
  }
  window.addEventListener('deviceorientation',adhanCompassHandler);

  await adhanGetQibla();

  if(!adhanCtx) adhanCtx=new(window.AudioContext||window.webkitAudioContext)();
  await adhanCtx.resume();

  if(!adhanDecodedBuf){
    try{
      const r=await fetch('https://cookmom.github.io/ramadan-clock/audio/adhan-mishari.mp3');
      const ab=await r.arrayBuffer();
      adhanDecodedBuf=await adhanCtx.decodeAudioData(ab);
    }catch(e){
      btn.innerHTML='<i class="ph-thin ph-play"></i> Play Spatial Adhan';
      return;
    }
  }

  adhanBufSrc=adhanCtx.createBufferSource();
  adhanBufSrc.buffer=adhanDecodedBuf;
  adhanPanner=adhanCtx.createStereoPanner();
  adhanGain=adhanCtx.createGain();
  adhanGain.gain.value=1.0;
  adhanBufSrc.connect(adhanGain).connect(adhanPanner).connect(adhanCtx.destination);

  updateAdhanPan();
  adhanInterval=setInterval(updateAdhanPan,100);

  adhanBufSrc.start(0);
  adhanBufSrc.onended=()=>{
    adhanBufSrc=null;
    if(adhanInterval){clearInterval(adhanInterval);adhanInterval=null;}
    btn.innerHTML='<i class="ph-thin ph-play"></i> Play Spatial Adhan';
  };

  btn.innerHTML=adhanHasCompass
    ?'<i class="ph-thin ph-pause"></i> Playing toward Qibla'
    :'<i class="ph-thin ph-pause"></i> Playing — al-Afasy';
}

// ══════════════════════════════════════════
// SCROLL OBSERVERS
// ══════════════════════════════════════════
function setupScrollObservers(){
  const opts={threshold:0.4};

  const observe=(id,fn)=>{
    const el=document.getElementById(id);
    if(!el)return;
    new IntersectionObserver((entries)=>{
      if(entries[0].isIntersecting) fn();
    },opts).observe(el);
  };

  observe('sec-hook',()=>{
    if(window._clockSwitchDial&&DIALS[dialIdx]!=='slate'){dialIdx=3;updateDial();}
    setNightMode(false);
  });

  observe('sec-qibla',()=>{
    setNightMode(false);
    if(window._clockQiblaDemo) window._clockQiblaDemo(true);
  });

  observe('sec-prayer',()=>{
    setNightMode(false);
    if(window._clockQiblaDemo) window._clockQiblaDemo(false);
  });

  observe('sec-dials',()=>{
    setNightMode(false);
    startDialCycle();
  });

  observe('sec-night',()=>{
    setNightMode(true);
  });

  observe('sec-adhan',()=>{
    setNightMode(true);
  });

  observe('sec-install',()=>{
    setNightMode(false);
  });

  new IntersectionObserver((entries)=>{
    if(!entries[0].isIntersecting) stopDialCycle();
  },{threshold:0.1}).observe(document.getElementById('sec-dials'));
}

function startDialCycle(){
  if(dialCycleTimer)return;
  dialCycleTimer=setInterval(()=>{dialNext()},2500);
}
function stopDialCycle(){
  if(dialCycleTimer){clearInterval(dialCycleTimer);dialCycleTimer=null;}
}

// ══════════════════════════════════════════
// REVEAL OBSERVER
// ══════════════════════════════════════════
const revealObs=new IntersectionObserver((entries)=>{
  entries.forEach(e=>{if(e.isIntersecting){e.target.classList.add('visible');revealObs.unobserve(e.target)}});
},{threshold:0.15,rootMargin:'0px 0px -40px 0px'});

// ══════════════════════════════════════════
// NAV SCROLL
// ══════════════════════════════════════════
const nav=document.querySelector('nav');
window.addEventListener('scroll',()=>{nav.classList.toggle('scrolled',window.scrollY>40)},{passive:true});

// ══════════════════════════════════════════
// PRAYER TIMES
// ══════════════════════════════════════════
(async()=>{
  let city='Los Angeles',country='US',apiUrl;
  try{
    const pos=await new Promise((r,j)=>navigator.geolocation?navigator.geolocation.getCurrentPosition(r,j,{maximumAge:300000,timeout:3000}):j());
    const lat=pos.coords.latitude,lon=pos.coords.longitude;
    apiUrl=`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=2`;
    try{const geoR=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
    const geo=await geoR.json();
    city=geo.address?.city||geo.address?.town||geo.address?.village||city;
    country=geo.address?.country_code?.toUpperCase()||country;}catch(e){}
  }catch(e){
    try{const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
    city=tz.split('/').pop().replace(/_/g,' ');}catch(e2){}
    apiUrl=`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=US&method=2`;
  }
  try{
    const r=await fetch(apiUrl);const j=await r.json();if(j.code!==200)return;
    const t=j.data.timings,d=j.data.date;
    document.getElementById('pcHijri').textContent=`${d.hijri.day} ${d.hijri.month.en} ${d.hijri.year} AH`;
    document.getElementById('pcGreg').textContent=`${d.gregorian.weekday.en}, ${d.gregorian.day} ${d.gregorian.month.en} ${d.gregorian.year}`;
    document.getElementById('pcLoc').textContent=`${city}${country?' · '+country:''}`;
    const prayers=['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'];
    const colors={Fajr:'#5b7fa5',Sunrise:'#e6a23c',Dhuhr:'#c8a44e',Asr:'#d4845e',Maghrib:'#c0392b',Isha:'#6366f1'};
    const now=new Date();const nowM=now.getHours()*60+now.getMinutes();
    const toMin=s=>{const[h,m]=s.split(':').map(Number);return h*60+m;};
    const to12=s=>{const[h,m]=s.split(':');const hr=parseInt(h);return(hr%12||12)+':'+m+(hr>=12?' PM':' AM');};
    let nextP='';
    prayers.forEach(p=>{const pm=toMin(t[p]);if(!nextP&&pm>nowM)nextP=p;});
    document.getElementById('pcTimes').innerHTML=prayers.map(p=>{
      const isNext=p===nextP;
      return`<div style="display:flex;justify-content:space-between;align-items:center;padding:.35rem 0;${isNext?'font-weight:500;':'font-weight:300;color:var(--dim);'}">
        <span style="display:flex;align-items:center;gap:.5rem"><span style="width:6px;height:6px;border-radius:50%;background:${colors[p]};display:inline-block"></span>${p}</span>
        <span style="font-variant-numeric:tabular-nums;font-size:.9rem">${to12(t[p])}</span></div>`;
    }).join('');
    if(nextP)document.getElementById('pcNext').textContent=`Next: ${nextP} at ${to12(t[nextP])}`;
  }catch(e){document.getElementById('pcHijri').textContent='Prayer times unavailable';}
})();

// ══════════════════════════════════════════
// INIT
// ══════════════════════════════════════════
buildDots();
document.querySelectorAll('.reveal').forEach(el=>revealObs.observe(el));

// Touch swipe on dial hero
(function(){
  const el=document.getElementById('dialHero');let sx=0,locked=false;
  el.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;locked=false},{passive:true});
  el.addEventListener('touchmove',e=>{
    const dx=Math.abs(e.touches[0].clientX-sx);
    if(dx>10&&!locked){locked=true;e.preventDefault();}
  },{passive:false});
  el.addEventListener('touchend',e=>{
    const dx=e.changedTouches[0].clientX-sx;
    if(Math.abs(dx)>40){dx<0?dialNext():dialPrev();}
  },{passive:true});
})();

// Always start at top on refresh
history.scrollRestoration='manual';
window.scrollTo({top:0,behavior:'instant'});
document.documentElement.scrollTop=0;
document.body.scrollTop=0;
setTimeout(()=>{window.scrollTo({top:0,behavior:'instant'});},50);
setTimeout(()=>{window.scrollTo({top:0,behavior:'instant'});},200);
setTimeout(()=>{window.scrollTo({top:0,behavior:'instant'});},500);

// Load 3D clock immediately
window._clockContainer=document.getElementById('dialHero');
const _cs=document.createElement('script');
_cs.type='module';_cs.src='clock.js?v=20';
document.head.appendChild(_cs);

// ══════════════════════════════════════════
// SCROLL → CLOCK INDICATOR
// ══════════════════════════════════════════
setTimeout(()=>{
  const secIds=['sec-hook','sec-qibla','sec-prayer','sec-dials','sec-night','sec-adhan','sec-install'];
  const secEls=secIds.map(id=>document.getElementById(id)).filter(Boolean);
  let lastIdx=-1;
  function updateScrollIndicator(){
    const snapLine=document.querySelector('.clock-sticky')?.getBoundingClientRect().bottom || 0;
    let activeIdx=0, bestDist=Infinity;
    for(let i=0;i<secEls.length;i++){
      const dist=Math.abs(secEls[i].getBoundingClientRect().top - snapLine);
      if(dist<bestDist){ bestDist=dist; activeIdx=i; }
    }
    if(activeIdx!==lastIdx){
      lastIdx=activeIdx;
      if(window._clockSetScrollSection) window._clockSetScrollSection(activeIdx);
    }
  }
  window.addEventListener('scroll',updateScrollIndicator,{passive:true});
  updateScrollIndicator();
},600);

setTimeout(setupScrollObservers,500);

// ══════════════════════════════════════════
// GUIDED TOUR — auto-scroll showroom mode
// ══════════════════════════════════════════
(function(){
  const TOUR_SECTIONS = [
    { id:'sec-hook',    dwell:5000 },
    { id:'sec-qibla',   dwell:7000 },
    { id:'sec-prayer',  dwell:8000 },
    { id:'sec-dials',   dwell:30000 },
    { id:'sec-night',   dwell:7000 },
    { id:'sec-adhan',   dwell:8000 },
    { id:'sec-install', dwell:6000 },
  ];

  let tourIdx=0, tourTimer=null, tourActive=false, tourScrolling=false;
  let idleTimer=null;
  const IDLE_START=10000;

  function startTour(){
    if(tourActive) return;
    tourActive=true;
    tourIdx=0;
    document.documentElement.style.scrollSnapType='none';
    try{
      const el=document.documentElement;
      if(el.requestFullscreen) el.requestFullscreen().catch(()=>{});
      else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    }catch(e){}
    advanceTour();
  }

  function stopTour(){
    tourActive=false;
    tourScrolling=false;
    if(tourTimer){clearTimeout(tourTimer);tourTimer=null;}
    if(idleTimer){clearTimeout(idleTimer);idleTimer=null;}
    document.documentElement.style.scrollSnapType='y mandatory';
    try{if(document.fullscreenElement) document.exitFullscreen().catch(()=>{});}catch(e){}
  }

  function advanceTour(){
    if(!tourActive) return;
    if(tourIdx >= TOUR_SECTIONS.length){
      tourIdx=0;
      tourScrolling=true;
      window.scrollTo({top:0,behavior:'smooth'});
      setTimeout(()=>{tourScrolling=false;},1500);
      tourTimer=setTimeout(()=>advanceTour(), 2000);
      return;
    }
    const sec=TOUR_SECTIONS[tourIdx];
    const el=document.getElementById(sec.id);
    if(el){
      tourScrolling=true;
      el.scrollIntoView({behavior:'smooth',block:'start'});
      setTimeout(()=>{tourScrolling=false;},1500);
    }
    if(sec.id==='sec-dials') startDialCycle();
    else stopDialCycle();
    if(sec.id==='sec-night') setNightMode(true);
    else if(sec.id==='sec-adhan') setNightMode(true);
    else setNightMode(false);
    if(sec.id==='sec-qibla'&&window._clockQiblaDemo) window._clockQiblaDemo(true);
    else if(window._clockQiblaDemo) window._clockQiblaDemo(false);
    if(sec.id==='sec-dials'&&window._clockLockCompass) window._clockLockCompass(true);
    else if(window._clockLockCompass) window._clockLockCompass(false);

    tourIdx++;
    tourTimer=setTimeout(()=>advanceTour(), sec.dwell);
  }

  function resetIdle(){
    if(idleTimer) clearTimeout(idleTimer);
    if(tourActive) stopTour();
    idleTimer=setTimeout(startTour, IDLE_START);
  }

  ['touchstart','mousedown','wheel','keydown'].forEach(evt=>{
    window.addEventListener(evt,()=>{
      if(tourActive) stopTour();
      resetIdle();
    },{passive:true});
  });

  setTimeout(resetIdle, 3000);
})();
</script>
</body>
</html>
