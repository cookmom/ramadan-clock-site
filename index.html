<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>A Gift of Time — Prayer Times, Islamic Prayer Clock, Qibla Compass & Spatial Adhan</title>
<meta name="description" content="A Gift of Time — a beautiful prayer clock for Muslims. Accurate prayer times, Qibla compass, spatial adhan toward Mecca, Ramadan fasting timer, and 11 dial designs named after Surahs. Free, no ads, no tracking — sadaqah jariyah.">
<meta name="keywords" content="A Gift of Time, prayer times, Islamic prayer times, prayer clock, Muslim prayer app, salah times, namaz times, Fajr time, Dhuhr time, Asr time, Maghrib time, Isha time, Qibla compass, Qibla direction, adhan notification, spatial adhan, Ramadan fasting clock, suhoor iftar timer, prayer reminder, Al-Fajr, Ash-Shams, Al-Asr, Al-Qadr, An-Nur, Al-Kawthar, Al-Mulk, Ar-Rahman, Al-Kahf, Ya-Sin, Al-Fatihah, Surah Yusuf, Islamic art, sadaqah jariyah, free Muslim app, agiftoftime">
<link rel="canonical" href="https://agiftoftime.app/">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://agiftoftime.app/">
<meta property="og:title" content="A Gift of Time — Prayer Times, Qibla Compass & Spatial Adhan">
<meta property="og:description" content="A Gift of Time — accurate prayer times, Qibla compass, spatial adhan toward Mecca, Ramadan fasting timer, and 11 Surah-named dials. Free, no ads — sadaqah jariyah.">
<meta property="og:image" content="https://agiftoftime.app/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="A Gift of Time prayer clock showing Arabic numerals, Qibla compass subdial, and prayer time indicators">
<meta property="og:site_name" content="A Gift of Time">
<meta property="og:locale" content="en_US">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="A Gift of Time — Prayer Times & Islamic Prayer Clock">
<meta name="twitter:description" content="A Gift of Time — prayer times, Qibla compass, spatial adhan toward Mecca, fasting timer. 11 dials named after Surahs. Free, no ads — sadaqah jariyah.">
<meta name="twitter:image" content="https://agiftoftime.app/og-image.png">
<meta name="twitter:image:alt" content="A Gift of Time prayer clock with Arabic numerals and Qibla compass">

<!-- Additional SEO -->
<meta name="author" content="Tawfeeq Martin">
<meta name="theme-color" content="#f8f7f4">
<meta name="apple-mobile-web-app-title" content="A Gift of Time">
<meta name="application-name" content="A Gift of Time">
<link rel="apple-touch-icon" href="https://agiftoftime.app/apple-touch-icon.png">

<!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "A Gift of Time",
  "url": "https://agiftoftime.app",
  "description": "A beautiful Three.js prayer clock for Muslims with accurate prayer times, Qibla compass, HRTF spatial adhan toward Mecca, Ramadan fasting tracker, and 11 dial designs named after Surahs of the Quran.",
  "applicationCategory": "LifestyleApplication",
  "operatingSystem": "Any",
  "browserRequirements": "Requires WebGL support",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  },
  "author": {
    "@type": "Person",
    "name": "Tawfeeq Martin",
    "url": "https://tawfeeqmartin.com"
  },
  "featureList": [
    "Accurate Islamic prayer times based on location",
    "Qibla compass with real-time direction to Mecca",
    "HRTF spatial adhan — sound from the direction of Qibla",
    "Ramadan fasting progress tracker (Suhoor to Iftar)",
    "11 dial designs named after Surahs of the Quran",
    "Night mode with SuperLuminova lume glow",
    "Tawaf animation at Maghrib",
    "Works offline as a Progressive Web App",
    "Three.js GPU-rendered with PBR materials and HDRI reflections",
    "No ads, no tracking — completely free"
  ],
  "screenshot": "https://agiftoftime.app/og-image.png",
  "inLanguage": "en",
  "isAccessibleForFree": true
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "What is A Gift of Time?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "A Gift of Time is a free Islamic prayer clock web app with accurate prayer times, Qibla compass, spatial adhan toward Mecca, fasting tracker, and 11 beautiful dial designs named after Surahs of the Quran. Built with Three.js and WebGL."
      }
    },
    {
      "@type": "Question",
      "name": "How does the spatial adhan work?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "The adhan audio is spatialized using the Web Audio API so the sound appears to come from the direction of Qibla (Mecca). When you turn your phone, the adhan shifts direction — best experienced with headphones."
      }
    },
    {
      "@type": "Question",
      "name": "Is A Gift of Time free?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes, completely free with no ads and no tracking. It is built as a sadaqah jariyah (ongoing charity) for the Muslim community."
      }
    },
    {
      "@type": "Question",
      "name": "How do I install it on my phone?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Open the clock in your mobile browser, tap Share, then select Add to Home Screen. It works offline as a Progressive Web App."
      }
    },
    {
      "@type": "Question",
      "name": "What are the 11 dial designs?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Each dial is named after a Surah of the Quran: Al-Fajr, Ash-Shams, Al-Asr, Al-Qadr, An-Nur, Al-Kawthar, Al-Mulk, Ar-Rahman, Al-Kahf, Ya-Sin, and Al-Fatihah. Inspired by Surah Yusuf 12:4 — eleven stars."
      }
    }
  ]
}
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&family=Lateef:wght@400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/thin/style.css">
<link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/fill/style.css">
<script type="importmap">
{"imports":{"three":"https://esm.sh/three@0.170.0","three/addons/":"https://esm.sh/three@0.170.0/examples/jsm/"}}
</script>
<script>
// Instant dark screen if opening in clock mode — prevents landing page flash
if(location.hash==='#clock'){document.documentElement.classList.add('clock-direct');document.documentElement.style.cssText='background:#585860;overflow:hidden';}
</script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f8f7f4;--bg-alt:#f0efe9;--text:#1a1a1a;--text-muted:#6b6b6b;
  --gold:#c8a44e;--border:#e5e3dd;
  --font:'Inter',system-ui,-apple-system,sans-serif;
  --clock-size:min(480px,85vw);
}
html{font-size:16px}
body{
  font-family:var(--font);background:var(--bg);color:var(--text);
  font-weight:300;line-height:1.6;-webkit-font-smoothing:antialiased;
  overflow-x:clip;width:100%;
  transition:background 1s ease,color 1s ease;
}

/* ── Sticky clock ── */
.clock-sticky{
  position:sticky;top:0;z-index:50;
  display:flex;align-items:center;justify-content:center;
  height:calc(var(--clock-size) + 4.5rem);
  padding:4rem 0 .5rem;
  background:var(--bg);
  transition:background 1s ease;
}
#dialHero{
  width:var(--clock-size);height:var(--clock-size);
  border-radius:50%;overflow:hidden;
  background:#585860;
  flex-shrink:0;
  transition:box-shadow 1.5s ease;
}

/* ── Nav ── */
nav{
  position:fixed;top:0;left:0;right:0;z-index:100;
  padding:.75rem 1.5rem;display:flex;align-items:center;justify-content:space-between;
  transition:background .3s,box-shadow .3s;
}
nav.scrolled{background:var(--bg);opacity:.97;backdrop-filter:blur(12px);box-shadow:0 1px 0 var(--border)}
.nav-logo{font-weight:500;font-size:.9rem;letter-spacing:.02em}

/* ── Buttons ── */
.btn{
  display:inline-flex;align-items:center;gap:.5rem;
  padding:.65rem 1.5rem;border-radius:100px;
  font-family:var(--font);font-size:.875rem;font-weight:500;
  cursor:pointer;border:none;transition:all .2s;
}
.btn-primary{background:var(--text);color:var(--bg)}
.btn-primary:hover{opacity:.85}
.btn-outline{
  background:transparent;border:1px solid var(--border);color:var(--text);
  transition:color .5s ease,background-color .5s ease,border-color .5s ease;
}
.btn-outline:hover{border-color:var(--text)}
.support-heart{display:inline-block;color:#e74c4c;font-size:1.1em;animation:heartpulse .833s ease-in-out infinite}
@keyframes heartpulse{0%,100%{transform:scale(1)}15%{transform:scale(1.25)}30%{transform:scale(1)}45%{transform:scale(1.15)}60%{transform:scale(1)}}
.sticky-cta{
  position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%) translateY(80px);
  z-index:900;display:flex;align-items:center;gap:.6rem;
  background:rgba(255,255,255,.88);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border:1px solid rgba(0,0,0,.08);border-radius:2rem;
  padding:.6rem 1.25rem;font-size:.8rem;font-weight:400;letter-spacing:.02em;
  color:rgba(0,0,0,.75);text-decoration:none;
  box-shadow:0 4px 24px rgba(0,0,0,.3);
  transition:transform .5s cubic-bezier(.4,0,.2,1),opacity .5s ease;
  opacity:0;pointer-events:none;
}
.sticky-cta.visible{transform:translateX(-50%) translateY(0);opacity:1;pointer-events:auto}
.sticky-cta .cta-heart{color:#e74c4c;font-size:1rem;display:inline-block;animation:heartpulse .833s ease-in-out infinite}
.sticky-cta .cta-count{font-size:.65rem;font-weight:300;opacity:.5;margin-left:-.2rem}
a{color:inherit;text-decoration:none}

/* ── Sections ── */
.scroll-section{
  min-height:80vh;
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  text-align:center;
  padding:0 2rem 6rem;
  position:relative;
  transition:background 1s ease,color 1s ease;
}
.section-header{
  position:sticky;top:calc(var(--clock-size) + 4.5rem);
  z-index:40;padding:.75rem 0 .5rem;
  background:var(--bg);transition:background 1s ease;
}
.section-label{
  font-weight:500;font-size:.7rem;letter-spacing:.15em;
  text-transform:uppercase;color:var(--gold);margin-bottom:.25rem;
}
.section-title{
  font-weight:600;font-size:clamp(2rem,5vw,3.5rem);
  line-height:1.15;letter-spacing:-.02em;margin-bottom:0;
  transition:color 1s ease;
}
.section-body{
  font-weight:200;font-size:1.05rem;line-height:1.7;
  color:var(--text-muted);max-width:480px;margin:0 auto;
  transition:color 1s ease;
}

/* ── Quran verse block ── */
.verse{text-align:center;margin-top:2rem;max-width:560px}
.verse-ar{
  font-family:'Lateef','Traditional Arabic',serif;
  font-size:clamp(1.5rem,3.5vw,2.2rem);line-height:2;
  direction:rtl;color:var(--text);margin-bottom:1rem;
  transition:color 1s ease;
}
.verse-en{
  font-size:1rem;font-weight:300;color:var(--text-muted);
  font-style:italic;line-height:1.7;margin-bottom:.5rem;
  transition:color 1s ease;
}
.verse-ref{
  font-size:.8rem;font-weight:500;letter-spacing:.08em;
  color:var(--text-muted);margin-bottom:1rem;
  transition:color 1s ease;
}

/* ── Reveal animation ── */
.reveal{opacity:0;transform:translateY(30px);transition:opacity .8s ease,transform .8s ease}
.reveal.visible{opacity:1;transform:none}
@media(prefers-reduced-motion:reduce){.reveal{opacity:1;transform:none;transition:none}}

/* ── Prayer card ── */

/* ── Dial picker ── */
.dial-dots{display:flex;gap:6px;justify-content:center;margin-top:1rem;flex-wrap:wrap}
.dial-dot{
  width:8px;height:8px;border-radius:50%;border:none;
  cursor:pointer;padding:0;transition:opacity .3s,transform .3s;
  opacity:.2;background:var(--text);
}
.dial-dot.active{opacity:.7;transform:scale(1.3)}

/* ── Install steps ── */
.steps{display:flex;gap:2rem;margin-top:2.5rem;justify-content:center;flex-wrap:wrap;max-width:100%}
.step{text-align:center;min-width:0;width:200px;flex-shrink:1}
.step-icon{font-size:2.5rem;color:var(--text-muted);margin-bottom:.75rem;transition:color 1s ease}
.step-num{font-weight:500;font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:var(--gold);margin-bottom:.4rem}
.step h3{font-weight:400;font-size:1rem;margin-bottom:.4rem;transition:color 1s ease}
.step p{font-weight:300;font-size:.875rem;color:var(--text-muted);line-height:1.5;transition:color 1s ease}

/* ── Scroll Snap ── */
html{scroll-snap-type:y mandatory;scroll-padding-top:calc(var(--clock-size) + 4.5rem)}
.scroll-section{scroll-snap-align:start}

/* ── Footer ── */
footer{
  scroll-snap-align:end;
  padding:3rem 2rem;text-align:center;border-top:1px solid var(--border);
  transition:border-color 1s ease;
}
footer p{font-weight:300;font-size:.85rem;color:var(--text-muted);transition:color 1s ease}
footer a{transition:color .2s}
footer a:hover{color:var(--text)}
.footer-sep{margin:0 .75rem;opacity:.4}

/* ── Adhan button ── */
.adhan-btn{
  margin-top:1.5rem;padding:.75rem 2rem;font-size:1rem;gap:.75rem;
}

@media(max-width:768px){
  .scroll-section{padding:1.5rem 1.5rem 4rem;min-height:60vh}
}
@media(min-width:769px){
  :root{--clock-size:min(500px,45vw)}
  .scroll-section{max-width:700px;margin:0 auto}
  .section-body{max-width:520px}
  footer{max-width:700px;margin:0 auto}
}
@media(min-width:1200px){
  :root{--clock-size:min(560px,35vw)}
  .scroll-section{max-width:800px}
}

/* ── Fullscreen Clock Overlay ── */
.clock-fs-overlay{position:fixed;inset:0;z-index:200;background:#585860;display:none;flex-direction:column;align-items:center;justify-content:center}
.clock-fs-overlay.active{display:flex}
/* Hide landing page content instantly when loading #clock */
html.clock-direct nav,.clock-direct .scroll-section,.clock-direct .clock-sticky,.clock-direct footer{display:none!important}
.clock-fs-overlay canvas{width:100%!important;height:100%!important;position:absolute;inset:0}
.clock-fs-close{position:fixed;top:calc(env(safe-area-inset-top,12px) + 12px);left:16px;z-index:210;background:none;border:none;color:rgba(255,255,255,.6);font-size:1.5rem;cursor:pointer;padding:8px;transition:opacity .5s ease}
.fs-chrome-hidden .clock-fs-close,.fs-chrome-hidden .fs-header,.fs-chrome-hidden .fs-mode-toggle,.fs-chrome-hidden .fs-dial-picker{opacity:0;pointer-events:none}
.fs-header{position:fixed;top:calc(env(safe-area-inset-top,12px) + 88px);left:0;right:0;font-family:var(--font);text-align:center;z-index:210;pointer-events:none;color:rgba(255,255,255,.65);transition:opacity .5s ease}
.fs-header .fs-datetime{font-size:.7rem;font-weight:300;letter-spacing:.06em}
.fs-header .fs-location{display:none}
.fs-prayer-bar{font-size:.6rem;font-weight:300;letter-spacing:.1em;margin-top:6px;opacity:.55}
.fs-mode-toggle{position:fixed;top:calc(env(safe-area-inset-top,12px) + 12px);right:16px;z-index:210;cursor:pointer;background:none;border:none;padding:8px;color:rgba(255,255,255,.6);transition:opacity .5s ease}
.fs-mode-toggle svg{width:20px;height:20px;stroke-width:1;fill:none;stroke:currentColor}
.fs-dial-picker{position:fixed;bottom:calc(env(safe-area-inset-bottom,12px) + 16px);left:0;right:0;text-align:center;font-family:var(--font);z-index:210;pointer-events:auto;color:rgba(255,255,255,.7);transition:opacity .5s ease}
.fs-dial-bar{display:flex;justify-content:center;gap:7px}
.fs-dial-bar .dial-dot{width:6px;height:6px;border-radius:50%;border:1.5px solid rgba(255,255,255,.25);cursor:pointer;transition:all .3s;background:none;padding:0}
.fs-dial-bar .dial-dot.active{border-color:rgba(255,255,255,.7);background:rgba(255,255,255,.4)}
</style>
</head>
<body>

<!-- Fullscreen Clock Overlay -->
<div id="clockFullscreen" class="clock-fs-overlay">
  <button id="clockFsClose" class="clock-fs-close" aria-label="Close">&times;</button>
  <div id="fsHeader" class="fs-header">
    <div class="fs-datetime" id="fsDateTime"></div>
    <div class="fs-location" id="fsLocation"></div>
    <div class="fs-prayer-bar" id="fsPrayerBar"><span id="fsPrayerTimes"></span></div>
  </div>
  <button id="fsModeToggle" class="fs-mode-toggle" aria-label="Toggle day/night"><svg id="fsModeIcon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button>
  <div id="fsDialPicker" class="fs-dial-picker">
    <div style="display:flex;align-items:center;gap:1.2rem;justify-content:center">
      <button onclick="fsPrevDial()" aria-label="Previous" style="background:none;border:none;cursor:pointer;padding:.5rem"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="1"><polyline points="15,18 9,12 15,6"/></svg></button>
      <div style="text-align:center;min-width:140px">
        <span id="fsDialSurah" style="font-size:.75rem;font-weight:500;letter-spacing:.1em;opacity:.8"></span>
      </div>
      <button onclick="fsNextDial()" aria-label="Next" style="background:none;border:none;cursor:pointer;padding:.5rem"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="1"><polyline points="9,6 15,12 9,18"/></svg></button>
    </div>
    <div id="fsDialBar" class="fs-dial-bar" style="margin-top:8px"></div>
    <button id="fsListenBtn" onclick="fsPlaySurah()" style="background:none;border:1px solid rgba(255,255,255,.2);border-radius:20px;color:rgba(255,255,255,.5);font-family:var(--font);font-size:.65rem;font-weight:300;letter-spacing:.08em;padding:.4rem 1rem;margin-top:10px;cursor:pointer;transition:opacity .2s"><svg viewBox="0 0 24 24" width="10" height="10" fill="none" stroke="currentColor" stroke-width="1.5" style="vertical-align:-1px;margin-right:4px"><polygon points="5,3 19,12 5,21"/></svg>Listen to this Surah</button>
  </div>
</div>

<!-- Nav -->
<nav>
  <div>
    <div class="nav-logo">A Gift of Time</div>
    <div id="navNext" style="font-size:.6rem;font-weight:500;letter-spacing:.06em;color:var(--text);margin-top:1px"></div>
  </div>
  <a href="#" class="btn btn-primary" style="font-size:.8rem;padding:.55rem 1.25rem" onclick="openClockFullscreen();return false;">Open Clock</a>
</nav>

<!-- Sticky Clock -->
<div class="clock-sticky">
  <div id="dialHero"></div>
</div>

<!-- 1. THE HOOK -->
<section class="scroll-section" id="sec-hook">
  <div class="reveal">
    <div class="section-header"><p class="section-label">Introducing</p>
    <h1 class="section-title" style="font-size:clamp(2.5rem,7vw,5rem);letter-spacing:-.03em">A Gift of Time.</h1></div>
    <p class="section-body">A prayer-aware clock for your family. Crafted with intention, rooted in the Quran.</p>
    <a href="support.html" class="btn btn-outline" style="margin-top:1rem"><i class="ph-fill ph-heart support-heart"></i> Keep this free</a>
  </div>
</section>

<!-- 2. QIBLA -->
<section class="scroll-section" id="sec-qibla">
  <div class="reveal">
    <div class="section-header"><p class="section-label">Direction</p>
    <h2 class="section-title">Always facing Qibla.</h2></div>
    <p class="section-body">The subdial compass finds the direction of al-Masjid al-Haram. Turn your phone, and it turns with you.</p>
    <div class="verse">
      <p class="verse-ar">فَوَلِّ وَجْهَكَ شَطْرَ ٱلْمَسْجِدِ ٱلْحَرَامِ</p>
      <p class="verse-en">"So turn your face toward al-Masjid al-Haram."</p>
      <p class="verse-ref">Al-Baqarah 2:144</p>
      <button onclick="playVerse(this,'https://cdn.islamic.network/quran/audio/128/ar.alafasy/151.mp3')" class="btn btn-outline" style="font-size:.85rem;padding:.6rem 1.25rem"><i class="ph-thin ph-play"></i> Listen</button>
    </div>
  </div>
</section>

<!-- 3. PRAYER TIMES -->
<section class="scroll-section" id="sec-prayer">
  <div class="reveal">
    <div class="section-header"><p class="section-label">Prayer Times</p>
    <h2 class="section-title" style="margin-bottom:0">Come to prayer.</h2>
    <p style="font-size:.75rem;font-weight:300;letter-spacing:.1em;color:var(--text-muted);opacity:.45;margin-bottom:0">Hayya 'ala as-salah</p></div>
    <p class="section-body">Automatic prayer times for your location. From Fajr to Isha, never miss a moment.</p>
    <div id="pcTimes" style="display:inline-block;font-size:.65rem;font-weight:600;letter-spacing:.08em;color:var(--gold);margin-top:1.25rem;padding:.6rem 1.25rem;background:rgba(200,164,78,.08);border:1px solid rgba(200,164,78,.15);border-radius:100px"></div>
    <div class="verse">
      <p class="verse-ar">إِنَّ ٱلصَّلَوٰةَ كَانَتْ عَلَى ٱلْمُؤْمِنِينَ كِتَـٰبًا مَّوْقُوتًا</p>
      <p class="verse-en">"Indeed, prayer has been decreed upon the believers at specified times."</p>
      <p class="verse-ref">An-Nisa 4:103</p>
      <button onclick="playVerse(this,'https://cdn.islamic.network/quran/audio/128/ar.alafasy/574.mp3')" class="btn btn-outline" style="font-size:.85rem;padding:.6rem 1.25rem"><i class="ph-thin ph-play"></i> Listen</button>
    </div>
  </div>
</section>

<!-- 4. ELEVEN DIALS -->
<section class="scroll-section" id="sec-dials">
  <div class="reveal">
    <div class="section-header"><p class="section-label">Dial Themes</p>
    <h2 class="section-title">Eleven stars, eleven dials.</h2></div>
    <p class="section-body">Each dial is named for a Surah of the Holy Quran — chosen to inspire reflection on mercy, creation, and time.</p>
    <div style="margin-top:1.5rem;display:flex;align-items:center;gap:1.5rem">
      <button onclick="dialPrev()" aria-label="Previous" style="background:none;border:none;cursor:pointer;padding:.5rem"><i class="ph-thin ph-caret-left" style="font-size:1.5rem;color:var(--text);opacity:.3"></i></button>
      <div style="text-align:center;min-width:200px">
        <span id="dialLabel" style="font-weight:400;font-size:.95rem;letter-spacing:.04em">Al-Layl</span>
        <div class="dial-dots" id="dialDots"></div>
      </div>
      <button onclick="dialNext()" aria-label="Next" style="background:none;border:none;cursor:pointer;padding:.5rem"><i class="ph-thin ph-caret-right" style="font-size:1.5rem;color:var(--text);opacity:.3"></i></button>
    </div>
    <button id="dialListen" onclick="playDialSurah()" class="btn btn-outline" style="font-size:.8rem;padding:.5rem 1rem;gap:.4rem;margin-top:1rem"><i class="ph-thin ph-play"></i> Listen to this Surah</button>
    <div class="verse" style="margin-top:2.5rem">
      <p class="verse-ar">إِذْ قَالَ يُوسُفُ لِأَبِيهِ يَـٰٓأَبَتِ إِنِّىٓ رَأَيْتُ أَحَدَ عَشَرَ كَوْكَبًا وَٱلشَّمْسَ وَٱلْقَمَرَ رَأَيْتُهُمْ لِى سَـٰجِدِينَ</p>
      <p class="verse-en">"When Joseph said to his father, 'O my father, indeed I have seen eleven stars and the sun and the moon; I saw them prostrating to me.'"</p>
      <p class="verse-ref">Yusuf 12:4</p>
      <button onclick="playVerse(this,'https://cdn.islamic.network/quran/audio/128/ar.alafasy/1378.mp3')" class="btn btn-outline" style="font-size:.85rem;padding:.6rem 1.25rem"><i class="ph-thin ph-play"></i> Listen</button>
    </div>
  </div>
</section>

<!-- 5. NIGHT MODE -->
<section class="scroll-section" id="sec-night">
  <div class="reveal">
    <div class="section-header"><p class="section-label">Night Mode</p>
    <h2 class="section-title">The lume reveals itself.</h2></div>
    <p class="section-body">As darkness falls, SuperLuminova indices glow to life. Each dial has its own lume colour — a quiet constellation on your wrist.</p>
    <div class="verse">
      <p class="verse-ar">وَجَعَلَ ٱلظُّلُمَـٰتِ وَٱلنُّورَ</p>
      <p class="verse-en">"And He made darknesses and light."</p>
      <p class="verse-ref">Al-An'am 6:1</p>
      <button onclick="playVerse(this,'https://cdn.islamic.network/quran/audio/128/ar.alafasy/728.mp3')" class="btn btn-outline" style="font-size:.85rem;padding:.6rem 1.25rem"><i class="ph-thin ph-play"></i> Listen</button>
    </div>
  </div>
</section>

<!-- 6. ADHAN -->
<section class="scroll-section" id="sec-adhan">
  <div class="reveal">
    <div class="section-header"><p class="section-label">Adhan</p>
    <h2 class="section-title">Hear the call to prayer.</h2></div>
    <p class="section-body">Mishary Rashid al-Afasy's voice, spatialized toward Qibla. The sound comes from the direction of Mecca.</p>
    <button id="adhanBtn" onclick="playAdhan(this)" class="btn btn-outline adhan-btn"><i class="ph-thin ph-play"></i> Play Spatial Adhan</button>
    <p style="font-size:.7rem;color:var(--text-muted);margin-top:.75rem;font-weight:300;opacity:.6">Best with headphones — sound moves toward Mecca as you turn</p>
  </div>
</section>

<!-- 7. INSTALL -->
<section class="scroll-section" id="sec-install">
  <div class="reveal">
    <div class="section-header"><p class="section-label">Install</p>
    <h2 class="section-title">Add to your home screen.</h2></div>
    <div class="steps">
      <div class="step">
        <i class="ph-thin ph-globe step-icon"></i>
        <p class="step-num">Step 1</p>
        <h3>Open in Safari</h3>
        <p>Visit the clock in your mobile browser.</p>
      </div>
      <div class="step">
        <i class="ph-thin ph-share-network step-icon"></i>
        <p class="step-num">Step 2</p>
        <h3>Tap Share</h3>
        <p>Select "Add to Home Screen."</p>
      </div>
      <div class="step">
        <i class="ph-thin ph-house step-icon"></i>
        <p class="step-num">Step 3</p>
        <h3>Launch anytime</h3>
        <p>Opens full-screen, like a native app.</p>
      </div>
    </div>
    <a href="#" class="btn btn-primary" style="margin-top:3rem" onclick="openClockFullscreen();return false;">Open Clock</a>
  </div>
</section>

<!-- Footer -->
<footer>
  <p style="margin-bottom:.5rem">By <a href="https://tawfeeqmartin.com" target="_blank" rel="noopener">Tawfeeq Martin</a></p>
  <p><a href="support.html">Support</a><span class="footer-sep">·</span><a href="mailto:feedback@agiftoftime.app">Feedback</a><span class="footer-sep">·</span><a href="privacy.html">Privacy & Terms</a></p>
</footer>

<script>
// ══════════════════════════════════════════
// DIAL DATA
// ══════════════════════════════════════════
const DIALS=['tennis','white','salmon','slate','sky','kawthar','dhuha','najm','qamar','ward','lilas'];
const DIAL_NAMES={'tennis':'Ar-Raḥmān','white':'An-Nūr','salmon':'Ash-Shams','slate':'Al-Layl','sky':'Al-Burūj','kawthar':'Al-Kawthar','dhuha':'Aḍ-Ḍuḥā','najm':'An-Najm','qamar':'Al-Qamar','ward':'Al-Wāqiʿah','lilas':'Al-Mulk'};
const DIAL_COLORS={'tennis':'#68b890','white':'#e8e4dc','salmon':'#d8988c','slate':'#585860','sky':'#82b8d8','kawthar':'#f2dce0','dhuha':'#f08040','najm':'#384870','qamar':'#c0c4cc','ward':'#d89098','lilas':'#8878a8'};
const DIAL_LUMES={'tennis':'#88ff30','white':'#ffa0c0','salmon':'#ffc070','slate':'#c8e8a0','sky':'#80d0ff','kawthar':'#ffa0c0','dhuha':'#ffc040','najm':'#90b8ff','qamar':'#e8f0ff','ward':'#ff80a8','lilas':'#c090ff'};
const DIAL_SURAHS={'tennis':55,'white':24,'salmon':91,'slate':92,'sky':85,'kawthar':108,'dhuha':93,'najm':53,'qamar':54,'ward':56,'lilas':67};

let dialIdx=3; // slate default
let pageNight=false;
let dialAudio=null, dialPlaying=false;
let adhanAudio=null, adhanPlaying=false;
let dialCycleTimer=null;

// ══════════════════════════════════════════
// VERSE AUDIO HELPER
// ══════════════════════════════════════════
function playVerse(btn,url){
  if(!btn._a){
    btn._a=new Audio(url);
    btn._a.onended=()=>{btn.innerHTML='<i class="ph-thin ph-play"></i> Listen'};
  }
  if(btn._a.paused){btn._a.play();btn.innerHTML='<i class="ph-thin ph-pause"></i> Playing'}
  else{btn._a.pause();btn.innerHTML='<i class="ph-thin ph-play"></i> Listen'}
}

// ══════════════════════════════════════════
// DIAL CONTROLS
// ══════════════════════════════════════════
function buildDots(){
  const c=document.getElementById('dialDots');
  c.innerHTML=DIALS.map((_,i)=>`<button class="dial-dot${i===dialIdx?' active':''}" onclick="switchDial(${i})" style="background:${DIAL_COLORS[DIALS[i]]}" aria-label="${DIAL_NAMES[DIALS[i]]}"></button>`).join('');
}
function switchDial(i){
  dialIdx=i;
  updateDial();
}
function updateDial(){
  const d=DIALS[dialIdx];
  document.getElementById('dialLabel').textContent=DIAL_NAMES[d];
  document.querySelectorAll('.dial-dot').forEach((dot,i)=>{
    dot.classList.toggle('active',i===dialIdx);
  });
  if(dialAudio&&!dialAudio.paused){dialAudio.pause();dialPlaying=false;}
  document.getElementById('dialListen').innerHTML='<i class="ph-thin ph-play"></i> Listen to this Surah';
  if(window._clockSwitchDial) window._clockSwitchDial(d);
  updateLumeHalo();
  // Sync fullscreen UI if active
  if(document.getElementById('clockFullscreen').classList.contains('active')){
    document.querySelectorAll('#fsDialBar .dial-dot').forEach(dot => dot.classList.toggle('active', dot.dataset.dial === d));
    document.getElementById('fsDialSurah').textContent = (typeof FS_DIAL_NAMES_MAP!=='undefined' && FS_DIAL_NAMES_MAP[d]) || DIAL_NAMES[d] || '';
    // Stop fullscreen surah if playing
    if(typeof fsSurahAudio!=='undefined' && fsSurahAudio && !fsSurahAudio.paused){
      fsSurahAudio.pause(); fsSurahAudio=null;
      const fb=document.getElementById('fsListenBtn');
      if(fb) fb.innerHTML=FS_PLAY_SVG+'Listen to this Surah';
    }
  }
}
function dialNext(){dialIdx=(dialIdx+1)%DIALS.length;updateDial();}
function dialPrev(){dialIdx=(dialIdx-1+DIALS.length)%DIALS.length;updateDial();}

function updateLumeHalo(){
  const hero=document.getElementById('dialHero');
  if(pageNight){
    const lume=DIAL_LUMES[DIALS[dialIdx]]||'#c8e8a0';
    hero.style.boxShadow='0 0 60px '+lume+'50, 0 0 120px '+lume+'25';
  }else{
    hero.style.boxShadow='none';
  }
}

function playDialSurah(){
  const num=DIAL_SURAHS[DIALS[dialIdx]];
  if(!num)return;
  const btn=document.getElementById('dialListen');
  if(dialPlaying&&dialAudio&&!dialAudio.paused){
    dialAudio.pause();dialPlaying=false;
    btn.innerHTML='<i class="ph-thin ph-play"></i> Listen to this Surah';return;
  }
  dialPlaying=true;
  dialAudio=new Audio('https://download.quranicaudio.com/qdc/mishari_al_afasy/murattal/'+num+'.mp3');
  dialAudio.onended=()=>{dialPlaying=false;btn.innerHTML='<i class="ph-thin ph-play"></i> Listen to this Surah'};
  dialAudio.play().catch(()=>{});
  btn.innerHTML='<i class="ph-thin ph-pause"></i> Playing — al-Afasy';
}

// ══════════════════════════════════════════
// NIGHT MODE
// ══════════════════════════════════════════
function setNightMode(on){
  if(pageNight===on)return;
  pageNight=on;
  const r=document.documentElement;
  if(on){
    r.style.setProperty('--bg','#0c0c12');
    r.style.setProperty('--bg-alt','#111114');
    r.style.setProperty('--text','#e8e4dc');
    r.style.setProperty('--text-muted','#8a8a8a');
    r.style.setProperty('--border','rgba(255,255,255,.08)');
  }else{
    r.style.setProperty('--bg','#f8f7f4');
    r.style.setProperty('--bg-alt','#f0efe9');
    r.style.setProperty('--text','#1a1a1a');
    r.style.setProperty('--text-muted','#6b6b6b');
    r.style.setProperty('--border','#e5e3dd');
  }
  document.querySelector('.clock-sticky').style.background=on?'#0c0c12':'var(--bg)';
  const pc=document.getElementById('prayerCard');
  if(pc){pc.style.background=on?'#141418':'#fff';pc.style.borderColor=on?'rgba(255,255,255,.08)':'var(--border)';}
  if(window._clockSetNight) window._clockSetNight(on);
  updateLumeHalo();
  // Hide all fullscreen chrome when night mode starts
  const fsClock=document.getElementById('clockFullscreen');
  if(fsClock){
    fsClock.classList.add('fs-chrome-hidden');
  }
}
// Tap to toggle chrome visibility in fullscreen (click = tap without drag)
document.addEventListener('click',function(e){
  const fsClock=document.getElementById('clockFullscreen');
  if(!fsClock||!fsClock.classList.contains('active'))return;
  if(e.target.closest('button,a,.fs-dial-bar,.fs-dial-picker'))return;
  fsClock.classList.toggle('fs-chrome-hidden');
});

// ══════════════════════════════════════════
// SPATIAL ADHAN — HRTF with Background/Foreground Handoff (v25)
// ══════════════════════════════════════════
// ARCHITECTURE:
//   - Foreground: HRTF via AudioBufferSourceNode + StereoPanner (no plain Audio)
//   - Background: plain Audio survives via MediaSession
//   - HIDE: get position, kill HRTF, resume plain Audio from position
//   - SHOW: get position from plain Audio, pause it, restart HRTF from position
//   - Plain Audio ONLY exists during background, never simultaneously with HRTF

const ADHAN_SRC='https://cookmom.github.io/ramadan-clock/audio/adhan-mishari.mp3';
let adhanCtx=null, adhanBufSrc=null, adhanPanner=null, adhanGain=null;
let adhanDecodedBuf=null, adhanPannerInterval=null;
let adhanHrtfStartCtxTime=0, adhanHrtfStartOffset=0;
let adhanHrtfStartWall=0;
let adhanDeviceHeading=0, adhanQiblaAngle=null, adhanCurrentPan=0;
let adhanHasCompass=false, adhanCompassEventCount=0;
let _preUnlockedAudio=null;
let _adhanBtn=null; // stash button ref for ended/visibility handlers

function adhanDbg(){console.log('[adhan]',...arguments);}

// ── Pre-unlock Audio on first tap (iOS requires user gesture) ──
function _preUnlockAudio(){
  if(_preUnlockedAudio)return;
  const a=new Audio(ADHAN_SRC);
  a.preload='auto';
  a.load();
  a._unlocked=false;a._isBackup=true;a._swapping=false;
  _preUnlockedAudio=a;
}
document.addEventListener('touchstart',function _unlockA(){
  _preUnlockAudio();
},{once:false});
document.addEventListener('click',function _unlockA2(){
  _preUnlockAudio();
},{once:false});

// ── Qibla + Compass ──
async function adhanGetQibla(){
  try{
    const pos=await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j,{maximumAge:300000,timeout:5000}));
    const lat=pos.coords.latitude*Math.PI/180, lng=pos.coords.longitude*Math.PI/180;
    const mLat=21.4225*Math.PI/180, mLng=39.8262*Math.PI/180;
    adhanQiblaAngle=Math.atan2(Math.sin(mLng-lng),Math.cos(lat)*Math.tan(mLat)-Math.sin(lat)*Math.cos(mLng-lng));
  }catch(e){}
}
function adhanCompassHandler(e){
  const h=e.webkitCompassHeading||e.alpha;
  if(h==null)return;
  adhanHasCompass=true;
  adhanCompassEventCount++;
  adhanDeviceHeading=h*Math.PI/180;
}

// ── Position tracking ──
function adhanPosition(){
  if(adhanAudio&&!adhanAudio.paused) return adhanAudio.currentTime;
  if(adhanHrtfStartWall>0&&adhanPlaying)
    return adhanHrtfStartOffset+(Date.now()-adhanHrtfStartWall)/1000;
  if(adhanCtx&&adhanBufSrc&&adhanCtx.state==='running')
    return adhanHrtfStartOffset+(adhanCtx.currentTime-adhanHrtfStartCtxTime);
  return adhanHrtfStartOffset;
}

// ── Panner update ──
let _lastPannerLog=0;
function updateAdhanPannerPosition(){
  if(!adhanPanner||!adhanHasCompass||!adhanCtx||adhanCtx.state!=='running')return;
  const h=adhanDeviceHeading||0;
  const ra=adhanQiblaAngle-h;
  const targetPan=Math.max(-1,Math.min(1,Math.sin(ra)));
  adhanCurrentPan+=(targetPan-adhanCurrentPan)*0.15;
  adhanPanner.pan.value=adhanCurrentPan;
  const now=Date.now();
  if(now-_lastPannerLog>2000){_lastPannerLog=now;adhanDbg('pan h='+(h*180/Math.PI).toFixed(0)+'° q='+(adhanQiblaAngle*180/Math.PI).toFixed(0)+'° pan='+adhanCurrentPan.toFixed(2)+' evt='+adhanCompassEventCount);}
}

// ── HRTF buffer start ──
function startHrtfBuffer(pos){
  if(adhanBufSrc){try{adhanBufSrc.stop();}catch(e){}adhanBufSrc=null;}
  if(!adhanCtx||!adhanDecodedBuf||!adhanPlaying)return Promise.reject('no ctx/buf');
  return adhanCtx.resume().then(()=>{
    const bufSrc=adhanCtx.createBufferSource();
    bufSrc.buffer=adhanDecodedBuf;
    adhanBufSrc=bufSrc;
    adhanPanner=adhanCtx.createStereoPanner();
    updateAdhanPannerPosition();
    adhanGain=adhanCtx.createGain();
    adhanGain.gain.value=2.0;
    bufSrc.connect(adhanGain).connect(adhanPanner).connect(adhanCtx.destination);
    adhanHrtfStartOffset=pos;
    adhanHrtfStartCtxTime=adhanCtx.currentTime;
    adhanHrtfStartWall=Date.now();
    if(adhanAudio&&!adhanAudio.paused){adhanAudio._swapping=true;adhanAudio.pause();setTimeout(()=>{if(adhanAudio)adhanAudio._swapping=false;},50);}
    bufSrc.start(0,pos);
    bufSrc.onended=()=>{
      if(adhanBufSrc===bufSrc){
        adhanBufSrc=null;
        if(!document.hidden){adhanPlaying=false;adhanHrtfStartWall=0;_adhanUpdateBtn();setTimeout(()=>{if(window._resumeTour)window._resumeTour();},3000);}
        adhanDbg('HRTF buf ended'+(document.hidden?' (bg)':' naturally'));
      }
    };
    adhanDbg('HRTF buf started pos='+pos.toFixed(2)+' ctx='+adhanCtx.state);
  });
}

// ── HRTF sequence: fetch + decode + start ──
function startHrtfSequence(src,startOffset){
  const offset=startOffset||0;
  adhanCtx=adhanCtx||new(window.AudioContext||window.webkitAudioContext)();
  if(adhanCtx.state==='suspended')adhanCtx.resume();
  adhanPannerInterval=setInterval(updateAdhanPannerPosition,200);
  adhanPlaying=true;
  fetch(src).then(r=>r.arrayBuffer())
    .then(buf=>adhanCtx.decodeAudioData(buf))
    .then(decoded=>{
      adhanDecodedBuf=decoded;
      adhanPlaying=true;
      adhanDbg('decoded '+decoded.duration.toFixed(1)+'s, starting HRTF from '+offset.toFixed(2));
      return startHrtfBuffer(offset);
    })
    .catch(e=>{
      adhanDbg('HRTF setup failed: '+e+', falling back to plain');
      adhanPlaying=true;
      if(adhanAudio&&adhanAudio._unlocked){adhanAudio.currentTime=0;adhanAudio.play().catch(()=>{});}
    });
}

// ── Button UI helper ──
function _adhanUpdateBtn(){
  if(!_adhanBtn)return;
  if(adhanPlaying){
    _adhanBtn.innerHTML=adhanHasCompass
      ?'<i class="ph-thin ph-pause"></i> Playing toward Qibla — turn your phone'
      :'<i class="ph-thin ph-pause"></i> Playing — al-Afasy';
  }else{
    _adhanBtn.innerHTML='<i class="ph-thin ph-play"></i> Play Spatial Adhan';
  }
}

// ── Setup ended/pause handlers + MediaSession ──
function setupAdhanAudioEvents(audio){
  audio.addEventListener('ended',()=>{
    adhanPlaying=false;
    if(adhanPannerInterval){clearInterval(adhanPannerInterval);adhanPannerInterval=null;}
    _adhanUpdateBtn();
    setTimeout(()=>{if(window._resumeTour)window._resumeTour();},3000);
    adhanDbg('plain audio ended');
  });
  audio.addEventListener('pause',()=>{
    if(audio._swapping)return;
    adhanPlaying=false;
    if(adhanPannerInterval){clearInterval(adhanPannerInterval);adhanPannerInterval=null;}
    _adhanUpdateBtn();
  });
  if('mediaSession' in navigator){
    navigator.mediaSession.metadata=new MediaMetadata({
      title:'Adhan',artist:'Mishari Rashid al-Afasy',album:'A Gift of Time'
    });
    navigator.mediaSession.setActionHandler('play',()=>{if(adhanAudio&&document.hidden)adhanAudio.play();});
    navigator.mediaSession.setActionHandler('pause',()=>{if(adhanAudio&&document.hidden)adhanAudio.pause();});
    navigator.mediaSession.setActionHandler('stop',()=>{if(adhanAudio){adhanAudio.pause();}adhanPlaying=false;_adhanUpdateBtn();});
  }
}

// ── Main play/stop entry point ──
async function playAdhan(btn){
  _adhanBtn=btn;
  // Stop if already playing
  if(adhanPlaying){
    adhanPlaying=false;
    if(adhanPannerInterval){clearInterval(adhanPannerInterval);adhanPannerInterval=null;}
    if(adhanBufSrc){try{adhanBufSrc.stop();}catch(e){}adhanBufSrc=null;}
    if(adhanAudio){adhanAudio.pause();adhanAudio=null;}
    adhanHrtfStartWall=0;
    _adhanUpdateBtn();
    if(window._resumeTour) window._resumeTour();
    return;
  }

  btn.innerHTML='<i class="ph-thin ph-circle-notch"></i> Loading...';

  // Request compass permission (iOS)
  if(typeof DeviceOrientationEvent!=='undefined'&&DeviceOrientationEvent.requestPermission){
    try{await DeviceOrientationEvent.requestPermission();}catch(e){}
  }
  window.addEventListener('deviceorientation',adhanCompassHandler);
  await adhanGetQibla();

  // Always use HRTF path for background/foreground handoff
  // If no Qibla angle, panning stays centered — still get MediaSession + handoff benefits
  const useHrtf=true;
  adhanDbg('playAdhan hrtf='+useHrtf+' qibla='+(adhanQiblaAngle!==null?'yes':'no'));

  // Kill previous state
  if(adhanBufSrc){try{adhanBufSrc.stop();}catch(e){}adhanBufSrc=null;}
  if(adhanAudio){adhanAudio.pause();adhanAudio=null;}
  if(adhanCtx&&adhanCtx!==null){try{adhanCtx.close();}catch(e){}}
  adhanCtx=null;adhanPanner=null;adhanGain=null;adhanDecodedBuf=null;

  adhanPlaying=true;
  _adhanUpdateBtn();
  // Pause tour — adhan is sacred, no scrolling during recitation
  if(window._pauseTour) window._pauseTour();
  if(window._stopTour) window._stopTour();

  // MediaSession metadata
  if('mediaSession' in navigator){
    navigator.mediaSession.metadata=new MediaMetadata({
      title:'Adhan',artist:'Mishari Rashid al-Afasy',album:'A Gift of Time'
    });
  }

  // audioSession.type for iOS 17+
  if('audioSession' in navigator){
    try{navigator.audioSession.type='playback';}catch(e){}
  }

  if(useHrtf){
    if(_preUnlockedAudio){
      adhanAudio=_preUnlockedAudio;
      _preUnlockedAudio=null;
      adhanAudio._swapping=true;
      adhanAudio.play().then(()=>{
        adhanAudio.pause();adhanAudio.currentTime=0;
        adhanAudio._unlocked=true;
        setupAdhanAudioEvents(adhanAudio);
        setTimeout(()=>{adhanAudio._swapping=false;},50);
        adhanDbg('pre-loaded Audio unlocked');
        startHrtfSequence(ADHAN_SRC,0);
      }).catch(e=>{
        adhanDbg('pre-loaded unlock failed: '+e);
        adhanAudio._swapping=false;
        _preUnlockedAudio=null;
        adhanAudio=new Audio(ADHAN_SRC);
        adhanAudio._isBackup=true;adhanAudio._unlocked=false;
        adhanAudio.play().then(()=>{
          adhanAudio._swapping=true;adhanAudio.pause();adhanAudio.currentTime=0;
          adhanAudio._unlocked=true;setupAdhanAudioEvents(adhanAudio);
          setTimeout(()=>{adhanAudio._swapping=false;},50);
          startHrtfSequence(ADHAN_SRC,0);
        }).catch(e2=>{
          adhanDbg('all unlock failed: '+e2);
          adhanAudio=new Audio(ADHAN_SRC);setupAdhanAudioEvents(adhanAudio);adhanAudio.play().catch(()=>{});
        });
      });
    }else{
      adhanAudio=new Audio(ADHAN_SRC);
      adhanAudio._isBackup=true;adhanAudio._unlocked=false;
      adhanAudio.play().then(()=>{
        adhanAudio._swapping=true;adhanAudio.pause();adhanAudio.currentTime=0;
        adhanAudio._unlocked=true;setupAdhanAudioEvents(adhanAudio);
        setTimeout(()=>{adhanAudio._swapping=false;},50);
        adhanDbg('plain Audio unlocked (fallback)');
        startHrtfSequence(ADHAN_SRC,0);
      }).catch(e=>{
        adhanDbg('plain unlock failed: '+e+', playing plain only');
        adhanAudio=new Audio(ADHAN_SRC);setupAdhanAudioEvents(adhanAudio);adhanAudio.play().catch(()=>{});
      });
    }
  }else{
    adhanAudio=new Audio(ADHAN_SRC);
    setupAdhanAudioEvents(adhanAudio);
    adhanAudio.play().catch(()=>{});
  }
}

// ── Visibility swap: HRTF ↔ Plain ──
document.addEventListener('visibilitychange',()=>{
  if(!adhanPlaying||!adhanDecodedBuf) return;

  if(document.hidden){
    // BACKGROUND: get position, kill HRTF, resume plain Audio
    const pos=adhanPosition();
    adhanDbg('HIDE: pos='+pos.toFixed(2)+' unlocked='+!!(adhanAudio&&adhanAudio._unlocked));
    if(adhanBufSrc){try{adhanBufSrc.stop();}catch(e){}adhanBufSrc=null;}
    if(adhanAudio&&adhanAudio._unlocked){
      adhanAudio._swapping=true;
      adhanAudio.currentTime=pos;
      adhanAudio.play().then(()=>{
        adhanAudio._swapping=false;
        adhanDbg('HIDE: plain resumed from pos='+pos.toFixed(2));
      }).catch(e=>{
        adhanAudio._swapping=false;
        adhanDbg('HIDE: plain resume failed: '+e);
      });
    }else{
      adhanDbg('HIDE: no unlocked Audio, silence in background');
    }
  }else{
    // FOREGROUND: try to upgrade to HRTF, but keep plain audio alive as fallback
    const pos=(adhanAudio&&!adhanAudio.paused)?adhanAudio.currentTime:adhanPosition();
    adhanDbg('SHOW: pos='+pos.toFixed(2)+' attempting HRTF upgrade');
    if(adhanDecodedBuf&&adhanCtx){
      if(!adhanPannerInterval)adhanPannerInterval=setInterval(updateAdhanPannerPosition,200);
      startHrtfBuffer(pos).then(()=>{
        // HRTF succeeded — now safe to kill plain audio
        if(adhanAudio&&!adhanAudio.paused){
          adhanAudio._swapping=true;
          adhanAudio.pause();
          setTimeout(()=>{if(adhanAudio)adhanAudio._swapping=false;},50);
        }
        adhanPlaying=true;
        if(!adhanPannerInterval)adhanPannerInterval=setInterval(updateAdhanPannerPosition,200);
        adhanDbg('SHOW: HRTF restored at pos='+pos.toFixed(2));
      }).catch(e=>{
        // HRTF failed — keep plain audio running, don't touch it
        adhanDbg('SHOW: HRTF failed, keeping plain audio: '+e);
        adhanPlaying=true;
      });
    }else{
      // No decoded buffer — just let plain audio keep playing
      adhanDbg('SHOW: no HRTF buffer, plain audio continues');
    }
  }
});

// ══════════════════════════════════════════
// SCROLL OBSERVERS
// ══════════════════════════════════════════
function setupScrollObservers(){
  // Track intersection ratios — only the most-visible section wins
  const sectionStates={
    'sec-hook':    ()=>{ if(window._clockSwitchDial&&DIALS[dialIdx]!=='slate'){dialIdx=3;updateDial();} setNightMode(false); },
    'sec-qibla':   ()=>{ setNightMode(false); if(window._clockQiblaDemo) window._clockQiblaDemo(true); },
    'sec-prayer':  ()=>{ setNightMode(false); if(window._clockQiblaDemo) window._clockQiblaDemo(false); },
    'sec-dials':   ()=>{ setNightMode(false); startDialCycle(); },
    'sec-night':   ()=>{ setNightMode(true); },
    'sec-adhan':   ()=>{ setNightMode(true); },
    'sec-install': ()=>{ setNightMode(false); },
  };
  const ratios={};
  let _lastActive='';
  const io=new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      const id=e.target.id;
      ratios[id]=e.isIntersecting?e.intersectionRatio:0;
    });
    // Find section with highest visibility
    let best='',bestR=0;
    for(const id in ratios){if(ratios[id]>bestR){bestR=ratios[id];best=id;}}
    if(best&&best!==_lastActive&&bestR>0.3){
      _lastActive=best;
      if(sectionStates[best]) sectionStates[best]();
    }
  },{threshold:[0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1]});
  Object.keys(sectionStates).forEach(id=>{
    const el=document.getElementById(id);
    if(el) io.observe(el);
  });

  // Stop dial cycle when leaving dials section
  new IntersectionObserver((entries)=>{
    if(!entries[0].isIntersecting) stopDialCycle();
  },{threshold:0.1}).observe(document.getElementById('sec-dials'));
}

function startDialCycle(){
  if(dialCycleTimer)return;
  dialCycleTimer=setInterval(()=>{dialNext()},2500);
}
function stopDialCycle(){
  if(dialCycleTimer){clearInterval(dialCycleTimer);dialCycleTimer=null;}
}

// ══════════════════════════════════════════
// REVEAL OBSERVER
// ══════════════════════════════════════════
const revealObs=new IntersectionObserver((entries)=>{
  entries.forEach(e=>{if(e.isIntersecting){e.target.classList.add('visible');revealObs.unobserve(e.target)}});
},{threshold:0.1,rootMargin:'0px 0px -40px 0px'});

// ══════════════════════════════════════════
// NAV SCROLL
// ══════════════════════════════════════════
const nav=document.querySelector('nav');
window.addEventListener('scroll',()=>{nav.classList.toggle('scrolled',window.scrollY>40)},{passive:true});

// ══════════════════════════════════════════
// PRAYER TIMES
// ══════════════════════════════════════════
(async()=>{
  let city='Los Angeles',country='US',apiUrl;
  try{
    const pos=await new Promise((r,j)=>navigator.geolocation?navigator.geolocation.getCurrentPosition(r,j,{maximumAge:300000,timeout:3000}):j());
    const lat=pos.coords.latitude,lon=pos.coords.longitude;
    apiUrl=`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=2`;
    try{const geoR=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
    const geo=await geoR.json();
    city=geo.address?.city||geo.address?.town||geo.address?.village||city;
    country=geo.address?.country_code?.toUpperCase()||country;}catch(e){}
  }catch(e){
    try{const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
    city=tz.split('/').pop().replace(/_/g,' ');}catch(e2){}
    apiUrl=`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=US&method=2`;
  }
  try{
    const r=await fetch(apiUrl);const j=await r.json();if(j.code!==200)return;
    const t=j.data.timings,d=j.data.date;
    const t5=['Fajr','Dhuhr','Asr','Maghrib','Isha'];
    const now=new Date();const nowM=now.getHours()*60+now.getMinutes();
    const toMin=s=>{const[h,m]=s.split(':').map(Number);return h*60+m;};
    let nextP='';t5.forEach(p=>{if(!nextP&&toMin(t[p])>nowM)nextP=p;});
    document.getElementById('pcTimes').innerHTML=t5.map(p=>{
      const hi=p===nextP;
      return`<span style="${hi?'font-weight:700;color:#c0392b':''}">` +p+' '+t[p]+'</span>';
    }).join(' · ');
    // Store for nav bar live clock
    window._prayerTimings=t;
    startNavClock();
  }catch(e){}
})();

// ── Nav bar live clock + next prayer ──
let _navClockTimer=null;
function startNavClock(){
  if(_navClockTimer)return;
  updateNavClock();
  _navClockTimer=setInterval(updateNavClock,1000);
}
function updateNavClock(){
  const t=window._prayerTimings;
  if(!t)return;
  const now=new Date();
  const nowS=now.getHours()*3600+now.getMinutes()*60+now.getSeconds();
  const t5=['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  const toSec=s=>{const[hh,mm]=s.split(':').map(Number);return hh*3600+mm*60;};
  const elNext=document.getElementById('navNext');
  if(elNext){
    let nextP='',nextS=0;
    t5.forEach(p=>{const ps=toSec(t[p]);if(!nextP&&ps>nowS){nextP=p;nextS=ps;}});
    if(nextP){
      let diff=nextS-nowS;
      const h=Math.floor(diff/3600);diff%=3600;
      const m=Math.floor(diff/60);
      const s=diff%60;
      const label=h>0?h+'h '+m+'m '+s+'s':m>0?m+'m '+s+'s':s+'s';
      elNext.textContent=nextP+' in '+label;
    }else{
      elNext.textContent='';
    }
  }
  // All prayer times
  const elTimes=document.getElementById('navTimes');
  if(elTimes&&!elTimes._set){
    elTimes.textContent=t5.map(p=>p+' '+((t[p]||'').split(' ')[0])).join(' · ');
    elTimes._set=true;
  }
}

// ── Service Worker + Notifications ──
let swReg=null;
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(r=>{swReg=r;}).catch(()=>{});
}
function requestNotifPermission(){
  if('Notification' in window&&Notification.permission==='default'){
    Notification.requestPermission();
  }
}
document.addEventListener('touchstart',requestNotifPermission,{once:true});
document.addEventListener('click',requestNotifPermission,{once:true});

// ── Auto-adhan at prayer times ──
let _lastAdhanFired='';
let _adhanCheckTimer=null;
// ── Prayer time tap-to-play banner (iOS fallback) ──
function _showAdhanBanner(prayer){
  let b=document.getElementById('adhanBanner');
  if(!b){
    b=document.createElement('div');b.id='adhanBanner';
    b.style.cssText='position:fixed;top:0;left:0;right:0;z-index:9999;background:rgba(26,71,42,.95);color:#fff;text-align:center;padding:1rem;font-family:var(--font);font-size:.95rem;font-weight:400;cursor:pointer;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);transition:opacity .3s';
    document.body.appendChild(b);
  }
  b.innerHTML='🕌 '+prayer+' — tap to hear the adhan';
  b.style.opacity='1';b.style.pointerEvents='auto';
  b.onclick=function(){
    const btn=document.getElementById('adhanBtn');
    if(btn) playAdhan(btn);
    _hideAdhanBanner();
  };
  // Auto-hide after 60s
  setTimeout(()=>_hideAdhanBanner(),60000);
}
function _hideAdhanBanner(){
  const b=document.getElementById('adhanBanner');
  if(b){b.style.opacity='0';b.style.pointerEvents='none';}
}

function startAdhanCheck(){
  if(_adhanCheckTimer)return;
  _adhanCheckTimer=setInterval(checkPrayerAdhan,15000); // check every 15s
}
function checkPrayerAdhan(){
  const t=window._prayerTimings;
  if(!t||adhanPlaying)return;
  const now=new Date();
  const nowHM=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  const prayers=['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  for(const p of prayers){
    const pTime=(t[p]||'').split(' ')[0];
    if(pTime===nowHM && _lastAdhanFired!==p+nowHM){
      _lastAdhanFired=p+nowHM;
      console.log('[adhan] Auto-triggering for '+p+' at '+nowHM);
      // Try auto-play first (works on Android, desktop, or if user interacted)
      let autoPlayed=false;
      if(_preUnlockedAudio&&_preUnlockedAudio._isBackup){
        adhanAudio=_preUnlockedAudio;_preUnlockedAudio=null;
        adhanAudio.currentTime=0;
        adhanPlaying=true;
        setupAdhanAudioEvents(adhanAudio);
        adhanAudio.play().then(()=>{
          adhanDbg('Auto-adhan plain playing for '+p);
          autoPlayed=true;
          if(window._pauseTour)window._pauseTour();
          if(window._stopTour)window._stopTour();
          _adhanUpdateBtn();
          _hideAdhanBanner();
        }).catch(e=>{
          adhanDbg('Auto-adhan play failed (no gesture): '+e);
          adhanPlaying=false;
          _showAdhanBanner(p);
        });
      }else{
        // Try playAdhan directly (works on Android, desktop)
        const btn=document.getElementById('adhanBtn');
        if(btn) { try{playAdhan(btn);}catch(e){} }
      }
      // Always show tap banner on iOS as fallback — user can tap to play
      if(!autoPlayed) _showAdhanBanner(p);
      // Browser notification
      if('Notification' in window&&Notification.permission==='granted'){
        if(swReg){
          swReg.showNotification(p+' Prayer',{body:'It\'s time for '+p+' prayer',tag:'prayer-'+p,renotify:true});
        }else{
          new Notification(p+' Prayer',{body:'It\'s time for '+p+' prayer',tag:'prayer-'+p});
        }
      }
      return;
    }
  }
}
// Start checking once prayer times are loaded
const _origStartNav=startNavClock;
startNavClock=function(){_origStartNav();startAdhanCheck();};

// ══════════════════════════════════════════
// INIT
// ══════════════════════════════════════════
buildDots();
document.querySelectorAll('.reveal').forEach(el=>revealObs.observe(el));

// Touch swipe on dial hero + fullscreen overlay
function addSwipe(el){
  let sx=0,locked=false;
  el.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;locked=false},{passive:true});
  el.addEventListener('touchmove',e=>{
    const dx=Math.abs(e.touches[0].clientX-sx);
    if(dx>10&&!locked){locked=true;e.preventDefault();}
  },{passive:false});
  el.addEventListener('touchend',e=>{
    const dx=e.changedTouches[0].clientX-sx;
    if(Math.abs(dx)>40){dx<0?dialNext():dialPrev();}
  },{passive:true});
}
addSwipe(document.getElementById('dialHero'));
addSwipe(document.getElementById('clockFullscreen'));

// Vertical swipe in fullscreen toggles day/night
(function(){
  const fs=document.getElementById('clockFullscreen');
  if(!fs)return;
  let sy=0,sx=0;
  fs.addEventListener('touchstart',e=>{sy=e.touches[0].clientY;sx=e.touches[0].clientX;},{passive:true});
  fs.addEventListener('touchend',e=>{
    if(!fs.classList.contains('active'))return;
    const dy=e.changedTouches[0].clientY-sy;
    const dx=Math.abs(e.changedTouches[0].clientX-sx);
    // Vertical swipe: >50px Y, and more vertical than horizontal
    if(Math.abs(dy)>50 && Math.abs(dy)>dx){
      setNightMode(!pageNight);
    }
  },{passive:true});
})();

// Auto-open fullscreen if URL has #clock
if(location.hash === '#clock') {
  const _waitClock = setInterval(()=>{
    if(window._clockSetFullscreen && document.querySelector('#dialHero canvas') && typeof openClockFullscreen === 'function') {
      clearInterval(_waitClock);
      setTimeout(()=>openClockFullscreen(), 200);
    }
  }, 200);
  setTimeout(()=>clearInterval(_waitClock), 8000);
}

// Always start at top on refresh
history.scrollRestoration='manual';
window.scrollTo({top:0,behavior:'instant'});
document.documentElement.scrollTop=0;
document.body.scrollTop=0;
// Belt and suspenders — force again after snap settles
setTimeout(()=>{window.scrollTo({top:0,behavior:'instant'});},50);
setTimeout(()=>{window.scrollTo({top:0,behavior:'instant'});},200);
setTimeout(()=>{window.scrollTo({top:0,behavior:'instant'});},500);

// ══════════════════════════════════════════
// FULLSCREEN CLOCK
// ══════════════════════════════════════════
const FS_DIALS_DATA = [
  {name:'tennis',color:'#68b890'},{name:'white',color:'#e8e4dc'},{name:'salmon',color:'#d8988c'},
  {name:'slate',color:'#6a6a74'},{name:'sky',color:'#82b8d8'},{name:'kawthar',color:'#f2dce0'},
  {name:'dhuha',color:'#f08040'},{name:'najm',color:'#384870'},{name:'qamar',color:'#c0c4cc'},
  {name:'ward',color:'#d89098'},{name:'lilas',color:'#8878a8'}
];
const FS_SURAH_MAP = {tennis:55,white:24,salmon:91,slate:92,sky:85,kawthar:108,dhuha:93,najm:53,qamar:54,ward:56,lilas:67};
const FS_DIAL_NAMES_MAP = {tennis:'Ar-Raḥmān',white:'An-Nūr',salmon:'Ash-Shams',slate:'Al-Layl',sky:'Al-Burūj',kawthar:'Al-Kawthar',dhuha:'Aḍ-Ḍuḥā',najm:'An-Najm',qamar:'Al-Qamar',ward:'Al-Wāqiʿah',lilas:'Al-Mulk'};
let fsNight = false;
let fsSurahAudio = null;

const SUN_SVG='<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
const MOON_SVG='<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';

function buildFsDialDots() {
  const bar = document.getElementById('fsDialBar');
  bar.innerHTML = FS_DIALS_DATA.map(d =>
    `<button class="dial-dot${d.name===DIALS[dialIdx]?' active':''}" data-dial="${d.name}" style="border-color:${d.color}" onclick="fsSwitchDial('${d.name}')" aria-label="${FS_DIAL_NAMES_MAP[d.name]}"></button>`
  ).join('');
}

function fsSwitchDial(name) {
  if(window._clockSwitchDial) window._clockSwitchDial(name);
  const idx = DIALS.indexOf(name);
  if(idx >= 0) { dialIdx = idx; updateDial(); }
  document.querySelectorAll('#fsDialBar .dial-dot').forEach(d => d.classList.toggle('active', d.dataset.dial === name));
  document.getElementById('fsDialSurah').textContent = FS_DIAL_NAMES_MAP[name] || '';
}
function fsPrevDial() {
  const names = FS_DIALS_DATA.map(d=>d.name);
  const cur = names.indexOf(DIALS[dialIdx]);
  const prev = (cur - 1 + names.length) % names.length;
  fsSwitchDial(names[prev]);
}
function fsNextDial() {
  const names = FS_DIALS_DATA.map(d=>d.name);
  const cur = names.indexOf(DIALS[dialIdx]);
  const next = (cur + 1) % names.length;
  fsSwitchDial(names[next]);
}

function fsUpdateModeIcon() {
  document.getElementById('fsModeIcon').innerHTML = fsNight ? SUN_SVG : MOON_SVG;
}

// Live clock for fullscreen header
let _fsClockTimer = null;
function fsUpdateDateTime() {
  const el = document.getElementById('fsDateTime');
  if(!el) return;
  const now = new Date();
  const date = now.toLocaleDateString('en-US',{weekday:'long', month:'long', day:'numeric', year:'numeric'});
  const time = now.toLocaleTimeString('en-US',{hour:'numeric', minute:'2-digit', hour12:true});
  el.textContent = `${date} · ${time}`;
}
// Client-side Hijri date — instant, no API needed
function getHijriDate() {
  // Use Intl.DateTimeFormat with islamic-umalqura calendar
  try {
    const fmt = new Intl.DateTimeFormat('en-u-ca-islamic-umalqura', {day:'numeric',month:'long',year:'numeric'});
    const parts = fmt.formatToParts(new Date());
    const day = parts.find(p=>p.type==='day')?.value || '';
    const month = parts.find(p=>p.type==='month')?.value || '';
    const year = parts.find(p=>p.type==='year')?.value || '';
    // Also get Arabic month name
    const fmtAr = new Intl.DateTimeFormat('ar-u-ca-islamic-umalqura', {month:'long'});
    const monthAr = fmtAr.format(new Date());
    return { day, month, year, monthAr };
  } catch(e) { return null; }
}
function fsStartClock() {
  // Set Hijri date instantly — no API wait
  const h = getHijriDate();
  if(h) {
    document.getElementById('fsDateTime').textContent = `${h.day} ${h.month} ${h.year} AH  ·  ${h.monthAr}`;
  } else {
    fsUpdateDateTime(); // Gregorian fallback
  }
}
function fsStopClock() {
  if(_fsClockTimer) { clearInterval(_fsClockTimer); _fsClockTimer = null; }
}

function fsSetPrayerTimes(t, hijri) {
  const _fpt5=['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  const _fnow=new Date(),_fnowM=_fnow.getHours()*60+_fnow.getMinutes();
  const _ftoM=s=>{const[h,m]=(s||'').split(':').map(Number);return h*60+m;};
  let _fnextP='';_fpt5.forEach(p=>{if(!_fnextP&&_ftoM(t[p])>_fnowM)_fnextP=p;});
  document.getElementById('fsPrayerTimes').innerHTML=_fpt5.map(p=>`<span style="${p===_fnextP?'color:#c0392b;font-weight:600':''}">${p} ${t[p]}</span>`).join(' · ');
  // Top header: Hijri date replaces Gregorian date/time
  if(hijri) {
    document.getElementById('fsDateTime').textContent = `${hijri.day} ${hijri.month.en} ${hijri.year} AH  ·  ${hijri.month.ar}`;
  }
  // Gregorian date removed from fullscreen
}
function fsSetLocation(text) {
  const el = document.getElementById('fsLocation');
  if(el && text) el.textContent = text;
}
async function fsFetchPrayer() {
  let resolved = false;

  async function fromCoords(lat, lon, locationName) {
    try {
      const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=2`);
      const j = await res.json();
      if(j.code===200 && !resolved) {
        resolved = true;
        fsSetPrayerTimes(j.data.timings, j.data.date && j.data.date.hijri);
        if(locationName) fsSetLocation(locationName);
        else {
          const tz = j.data.meta && j.data.meta.timezone;
          if(tz) fsSetLocation(tz.split('/').pop().replace(/_/g,' '));
        }
      }
      // Upgrade location with reverse geocode (non-blocking)
      fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`)
        .then(r=>r.json()).then(g=>{
          const city = g.city || g.locality || '';
          const region = g.principalSubdivisionCode ? g.principalSubdivisionCode.split('-').pop() : '';
          if(city) fsSetLocation(region ? `${city}, ${region}` : city);
        }).catch(()=>{});
    } catch(e) {}
  }

  // Race: GPS vs IP geolocation — first to resolve wins
  // GPS path
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => fromCoords(pos.coords.latitude, pos.coords.longitude),
      ()=>{}, {maximumAge:600000, timeout:5000}
    );
  }

  // IP path (starts immediately, doesn't wait for GPS)
  try {
    const ipRes = await fetch('https://ipapi.co/json/', {signal: AbortSignal.timeout(4000)});
    const ip = await ipRes.json();
    if(ip.latitude && ip.longitude) {
      const loc = ip.city ? (ip.region_code ? `${ip.city}, ${ip.region_code}` : ip.city) : '';
      await fromCoords(ip.latitude, ip.longitude, loc);
    }
  } catch(e) {}

  // Last resort: hardcoded LA if nothing worked after 6s
  setTimeout(() => {
    if(!resolved) fromCoords(34.05, -118.25, 'Los Angeles, CA');
  }, 6000);
}

function openClockFullscreen() {
  const overlay = document.getElementById('clockFullscreen');
  const canvas = document.querySelector('#dialHero canvas');
  if(!canvas) return;

  // Stop tour/idle — pause all landing page animations in fullscreen
  stopDialCycle();
  if(window._stopTour) window._stopTour();

  // Move canvas into overlay
  overlay.appendChild(canvas);
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
  document.querySelector('nav').style.display = 'none';

  // Tell clock engine to go fullscreen — double resize to handle layout timing
  if(window._clockSetFullscreen) window._clockSetFullscreen(true);
  // Force re-resize after layout settles (fixes occasional oversized dial)
  requestAnimationFrame(() => { if(window._clockOnResize) window._clockOnResize(); });

  // Set night to match current page state
  fsNight = pageNight;
  fsUpdateModeIcon();

  // Build dial dots
  buildFsDialDots();
  const cur = DIALS[dialIdx];
  document.getElementById('fsDialSurah').textContent = DIAL_NAMES[cur] || '';

  // Fetch prayer times + start live clock
  fsFetchPrayer();
  fsStartClock();

  // Push history state for back button
  history.pushState({clockFs:true}, '', '#clock');
}

function closeClockFullscreen() {
  const overlay = document.getElementById('clockFullscreen');
  const canvas = overlay.querySelector('canvas');
  if(!canvas) return;

  // Move canvas back
  document.getElementById('dialHero').appendChild(canvas);
  overlay.classList.remove('active');
  document.body.style.overflow = '';
  document.querySelector('nav').style.display = '';

  // Tell clock engine to go back to contained
  if(window._clockSetFullscreen) window._clockSetFullscreen(false);
  fsStopClock();

  // Restore landing page theme-color + show content
  const m=document.querySelector('meta[name="theme-color"]'); if(m) m.content='#f8f7f4';
  document.documentElement.classList.remove('clock-direct');
  document.documentElement.style.cssText='';

  // Clear #clock from URL
  if(location.hash === '#clock') history.replaceState(null, '', location.pathname);

  // Stop any fullscreen surah audio
  if(fsSurahAudio && !fsSurahAudio.paused) { fsSurahAudio.pause(); fsSurahAudio = null; }
}

// Close button
document.getElementById('clockFsClose').addEventListener('click', () => {
  closeClockFullscreen();
  if(location.hash === '#clock') history.back();
});

// Back button
window.addEventListener('popstate', (e) => {
  if(document.getElementById('clockFullscreen').classList.contains('active')) {
    closeClockFullscreen();
  }
});

// Mode toggle in fullscreen
document.getElementById('fsModeToggle').addEventListener('click', () => {
  fsNight = !fsNight;
  fsUpdateModeIcon();
  if(window._clockSetNight) window._clockSetNight(fsNight);
  setNightMode(fsNight);
});

// Listen button in fullscreen
const FS_PLAY_SVG='<svg viewBox="0 0 24 24" width="10" height="10" fill="none" stroke="currentColor" stroke-width="1.5" style="vertical-align:-1px;margin-right:4px"><polygon points="5,3 19,12 5,21"/></svg>';
const FS_PAUSE_SVG='<svg viewBox="0 0 24 24" width="10" height="10" fill="none" stroke="currentColor" stroke-width="1.5" style="vertical-align:-1px;margin-right:4px"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
function fsPlaySurah() {
  const cur = DIALS[dialIdx];
  const num = FS_SURAH_MAP[cur];
  if(!num) return;
  const btn=document.getElementById('fsListenBtn');
  if(fsSurahAudio && !fsSurahAudio.paused) { fsSurahAudio.pause(); fsSurahAudio = null; btn.innerHTML=FS_PLAY_SVG+'Listen to this Surah'; return; }
  fsSurahAudio = new Audio(`https://download.quranicaudio.com/qdc/mishari_al_afasy/murattal/${num}.mp3`);
  fsSurahAudio.play().catch(()=>{});
  btn.innerHTML=FS_PAUSE_SVG+'Playing — al-Afasy';
  fsSurahAudio.onended=()=>{fsSurahAudio=null;btn.innerHTML=FS_PLAY_SVG+'Listen to this Surah';};
}

// Load 3D clock immediately
window._clockContainer=document.getElementById('dialHero');
const _cs=document.createElement('script');
_cs.type='module';_cs.src='clock.js?v=114';
document.head.appendChild(_cs);

// ══════════════════════════════════════════
// SCROLL → CLOCK INDICATOR (scroll-position based, not IntersectionObserver)
// ══════════════════════════════════════════
setTimeout(()=>{
  const secIds=['sec-hook','sec-qibla','sec-prayer','sec-dials','sec-night','sec-adhan','sec-install'];
  const secEls=secIds.map(id=>document.getElementById(id)).filter(Boolean);
  // Offset = sticky clock height (clock-size + 5.5rem ≈ top of content area)
  let lastIdx=-1;
  function updateScrollIndicator(){
    const scrollTop=window.scrollY;
    // Find the last section whose top has scrolled past the clock bottom
    // Find which section is snapped — closest top to the snap line (just below clock)
    const snapLine=document.querySelector('.clock-sticky')?.getBoundingClientRect().bottom || 0;
    let activeIdx=0, bestDist=Infinity;
    for(let i=0;i<secEls.length;i++){
      const dist=Math.abs(secEls[i].getBoundingClientRect().top - snapLine);
      if(dist<bestDist){ bestDist=dist; activeIdx=i; }
    }
    if(activeIdx!==lastIdx){
      lastIdx=activeIdx;
      if(window._clockSetScrollSection) window._clockSetScrollSection(activeIdx);
    }
  }
  window.addEventListener('scroll',updateScrollIndicator,{passive:true});
  updateScrollIndicator(); // set initial
},600);

// Setup scroll observers after a brief delay to let clock init
setTimeout(setupScrollObservers,500);

// ══════════════════════════════════════════
// GUIDED TOUR — auto-scroll showroom mode
// ══════════════════════════════════════════
(function(){
  const TOUR_SECTIONS = [
    { id:'sec-hook',    dwell:5000 },
    { id:'sec-qibla',   dwell:9000, scrollReveal:3000 },
    { id:'sec-prayer',  dwell:10000, scrollReveal:3500 },
    { id:'sec-dials',   dwell:30000 }, // 11 dials × 2.5s + buffer
    { id:'sec-night',   dwell:7000 },
    { id:'sec-adhan',   dwell:8000 },  // linger, no auto-play
    { id:'sec-install', dwell:6000 },
  ];

  let tourIdx=0, tourTimer=null, tourActive=false, tourScrolling=false;
  let idleTimer=null;
  const IDLE_START=10000; // start tour after 10s idle

  function startTour(){
    if(tourActive) return;
    tourActive=true;
    tourIdx=0;
    // Disable scroll-snap so tour can scroll freely
    document.documentElement.style.scrollSnapType='none';
    // Request fullscreen on mobile for immersive demo
    try{
      const el=document.documentElement;
      if(el.requestFullscreen) el.requestFullscreen().catch(()=>{});
      else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    }catch(e){}
    advanceTour();
  }

  function stopTour(){
    tourActive=false;
    tourScrolling=false;
    if(tourTimer){clearTimeout(tourTimer);tourTimer=null;}
    if(idleTimer){clearTimeout(idleTimer);idleTimer=null;}
    // Re-enable scroll-snap
    document.documentElement.style.scrollSnapType='y mandatory';
    // Exit fullscreen
    try{if(document.fullscreenElement) document.exitFullscreen().catch(()=>{});}catch(e){}
  }
  window._stopTour = stopTour;

  // Pause/resume for surah playback — freezes tour timer without killing the tour
  let _tourPaused = false, _tourRemainingMs = 0, _tourPauseTime = 0;
  function pauseTour(){
    if(!tourActive || _tourPaused) return;
    _tourPaused = true;
    // Capture remaining time on current dwell timer
    if(tourTimer){ clearTimeout(tourTimer); tourTimer=null; }
    _tourRemainingMs = Math.max(0, _tourPauseTime ? 0 : 2000); // fallback 2s
  }
  function resumeTour(){
    if(!tourActive || !_tourPaused) return;
    _tourPaused = false;
    tourTimer = setTimeout(()=>advanceTour(), _tourRemainingMs || 2000);
  }
  window._pauseTour = pauseTour;
  window._resumeTour = resumeTour;

  function advanceTour(){
    if(!tourActive) return;
    if(tourIdx >= TOUR_SECTIONS.length){
      tourIdx=0;
      tourScrolling=true;
      window.scrollTo({top:0,behavior:'smooth'});
      setTimeout(()=>{tourScrolling=false;},1500);
      tourTimer=setTimeout(()=>advanceTour(), 2000);
      return;
    }
    const sec=TOUR_SECTIONS[tourIdx];
    const el=document.getElementById(sec.id);
    if(el){
      tourScrolling=true;
      el.scrollIntoView({behavior:'smooth',block:'start'});
      setTimeout(()=>{tourScrolling=false;},1500);
    }
    // Trigger section-specific actions
    if(sec.id==='sec-dials') startDialCycle();
    else stopDialCycle();
    if(sec.id==='sec-night') setNightMode(true);
    else if(sec.id==='sec-adhan') setNightMode(true);
    else setNightMode(false);
    // Qibla compass demo — only on direction section
    if(sec.id==='sec-qibla'&&window._clockQiblaDemo) window._clockQiblaDemo(true);
    else if(window._clockQiblaDemo) window._clockQiblaDemo(false);
    // Lock compass at noon during dial showcase
    if(sec.id==='sec-dials'&&window._clockLockCompass) window._clockLockCompass(true);
    else if(window._clockLockCompass) window._clockLockCompass(false);

    // Intra-section scroll: gently reveal verse/deeper content mid-dwell
    if(el && sec.scrollReveal){
      setTimeout(()=>{
        if(!tourActive)return;
        const verse=el.querySelector('.verse');
        if(verse) verse.scrollIntoView({behavior:'smooth',block:'end'});
      }, sec.scrollReveal);
    }

    tourIdx++;
    tourTimer=setTimeout(()=>advanceTour(), sec.dwell);
  }

  function resetIdle(){
    if(idleTimer) clearTimeout(idleTimer);
    if(tourActive) stopTour();
    // Don't restart idle timer while clock is fullscreen
    if(document.getElementById('clockFullscreen').classList.contains('active')) return;
    idleTimer=setTimeout(startTour, IDLE_START);
  }

  // User interaction pauses tour — touch/mouse/key only (scroll events unreliable with snap)
  ['touchstart','mousedown','wheel','keydown'].forEach(evt=>{
    window.addEventListener(evt,()=>{
      if(tourActive) stopTour();
      resetIdle();
    },{passive:true});
  });

  // Don't start idle timer until page is loaded and settled
  setTimeout(resetIdle, 3000);
})();

// Sticky CTA — appears after engagement (surah play, fullscreen, or deep scroll)
(function(){
  const sticky=document.querySelector('.sticky-cta');
  if(!sticky) return;
  let shown=false;
  function show(){
    if(shown) return; shown=true;
    sticky.classList.add('visible');
  }
  function hide(){ sticky.classList.remove('visible'); shown=false; }
  // Trigger: scroll past 2nd section or any scroll beyond 1.5 viewports
  const observer=new IntersectionObserver((entries)=>{
    entries.forEach(e=>{ if(e.isIntersecting) show(); });
  },{threshold:0.1});
  const sec3=document.getElementById('sec-qibla')||document.querySelectorAll('.scroll-section')[1];
  if(sec3) observer.observe(sec3);
  window.addEventListener('scroll',()=>{ if(window.scrollY > window.innerHeight * 0.5) show(); },{passive:true});
  setTimeout(show, 8000); // fallback: show after 8s engagement
  // Trigger: surah play or fullscreen open
  const origListenClick=document.getElementById('listenBtn');
  document.addEventListener('click',(e)=>{
    if(e.target.closest('#listenBtn')||e.target.closest('[onclick*="playVerse"]')) show();
  });
  // Hide in fullscreen clock view
  const fsClock=document.getElementById('clockFullscreen');
  if(fsClock){
    new MutationObserver(()=>{
      if(fsClock.classList.contains('active')) sticky.classList.remove('visible');
      else if(shown) sticky.classList.add('visible');
    }).observe(fsClock,{attributes:true,attributeFilter:['class']});
  }
  // Fetch supporter count from Supabase
  fetch('https://ypniokxbftuebagppxzj.supabase.co/rest/v1/signups?select=id',{
    headers:{'apikey':'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlwbmlva3hiZnR1ZWJhZ3BweHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExOTQ2MjcsImV4cCI6MjA4Njc3MDYyN30.u63gpVUX7bOm5WQZkgt1elVWwwSBx_UGektwDTnllhw',
      'Prefer':'count=exact'}
  }).then(r=>{
    const count=parseInt(r.headers.get('content-range')?.split('/')[1]||'0');
    const el=document.querySelector('.cta-count');
    if(el&&count>0) el.textContent=count+' supporters';
  }).catch(()=>{});
})();

// Heart is always filled red + pulsing via CSS animation
</script>
<a href="support.html" class="sticky-cta">
  <i class="ph-fill ph-heart cta-heart"></i>
  <span>Keep this free</span>
  <span class="cta-count"></span>
</a>
</body>
</html>
