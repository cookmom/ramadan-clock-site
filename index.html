<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>A Gift of Time — Prayer Times, Islamic Prayer Clock, Qibla Compass & Spatial Adhan</title>
<meta name="description" content="A Gift of Time — a beautiful prayer clock for Muslims. Accurate prayer times, Qibla compass, spatial adhan toward Mecca, Ramadan fasting timer, and 11 dial designs named after Surahs. Free, no ads, no tracking — sadaqah jariyah.">
<meta name="keywords" content="A Gift of Time, prayer times, Islamic prayer times, prayer clock, Muslim prayer app, salah times, namaz times, Fajr time, Dhuhr time, Asr time, Maghrib time, Isha time, Qibla compass, Qibla direction, adhan notification, spatial adhan, Ramadan fasting clock, suhoor iftar timer, prayer reminder, Al-Fajr, Ash-Shams, Al-Asr, Al-Qadr, An-Nur, Al-Kawthar, Al-Mulk, Ar-Rahman, Al-Kahf, Ya-Sin, Al-Fatihah, Surah Yusuf, Islamic art, sadaqah jariyah, free Muslim app, agiftoftime">
<link rel="canonical" href="https://agiftoftime.app/">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://agiftoftime.app/">
<meta property="og:title" content="A Gift of Time — Prayer Times, Qibla Compass & Spatial Adhan">
<meta property="og:description" content="A Gift of Time — accurate prayer times, Qibla compass, spatial adhan toward Mecca, Ramadan fasting timer, and 11 Surah-named dials. Free, no ads — sadaqah jariyah.">
<meta property="og:image" content="https://agiftoftime.app/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="A Gift of Time prayer clock showing Arabic numerals, Qibla compass subdial, and prayer time indicators">
<meta property="og:site_name" content="A Gift of Time">
<meta property="og:locale" content="en_US">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="A Gift of Time — Prayer Times & Islamic Prayer Clock">
<meta name="twitter:description" content="A Gift of Time — prayer times, Qibla compass, spatial adhan toward Mecca, fasting timer. 11 dials named after Surahs. Free, no ads — sadaqah jariyah.">
<meta name="twitter:image" content="https://agiftoftime.app/og-image.png">
<meta name="twitter:image:alt" content="A Gift of Time prayer clock with Arabic numerals and Qibla compass">

<!-- Additional SEO -->
<meta name="author" content="Tawfeeq Martin">
<meta name="theme-color" content="#f8f7f4">
<meta name="apple-mobile-web-app-title" content="A Gift of Time">
<meta name="application-name" content="A Gift of Time">
<link rel="apple-touch-icon" href="https://agiftoftime.app/apple-touch-icon.png">

<!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "A Gift of Time",
  "url": "https://agiftoftime.app",
  "description": "A beautiful Three.js prayer clock for Muslims with accurate prayer times, Qibla compass, HRTF spatial adhan toward Mecca, Ramadan fasting tracker, and 11 dial designs named after Surahs of the Quran.",
  "applicationCategory": "LifestyleApplication",
  "operatingSystem": "Any",
  "browserRequirements": "Requires WebGL support",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  },
  "author": {
    "@type": "Person",
    "name": "Tawfeeq Martin",
    "url": "https://tawfeeqmartin.com"
  },
  "featureList": [
    "Accurate Islamic prayer times based on location",
    "Qibla compass with real-time direction to Mecca",
    "HRTF spatial adhan — sound from the direction of Qibla",
    "Ramadan fasting progress tracker (Suhoor to Iftar)",
    "11 dial designs named after Surahs of the Quran",
    "Night mode with SuperLuminova lume glow",
    "Tawaf animation at Maghrib",
    "Works offline as a Progressive Web App",
    "Three.js GPU-rendered with PBR materials and HDRI reflections",
    "No ads, no tracking — completely free"
  ],
  "screenshot": "https://agiftoftime.app/og-image.png",
  "inLanguage": "en",
  "isAccessibleForFree": true
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "What is A Gift of Time?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "A Gift of Time is a free Islamic prayer clock web app with accurate prayer times, Qibla compass, spatial adhan toward Mecca, fasting tracker, and 11 beautiful dial designs named after Surahs of the Quran. Built with Three.js and WebGL."
      }
    },
    {
      "@type": "Question",
      "name": "How does the spatial adhan work?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "The adhan audio is spatialized using the Web Audio API so the sound appears to come from the direction of Qibla (Mecca). When you turn your phone, the adhan shifts direction — best experienced with headphones."
      }
    },
    {
      "@type": "Question",
      "name": "Is A Gift of Time free?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes, completely free with no ads and no tracking. It is built as a sadaqah jariyah (ongoing charity) for the Muslim community."
      }
    },
    {
      "@type": "Question",
      "name": "How do I install it on my phone?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Open the clock in your mobile browser, tap Share, then select Add to Home Screen. It works offline as a Progressive Web App."
      }
    },
    {
      "@type": "Question",
      "name": "What are the 11 dial designs?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Each dial is named after a Surah of the Quran: Al-Fajr, Ash-Shams, Al-Asr, Al-Qadr, An-Nur, Al-Kawthar, Al-Mulk, Ar-Rahman, Al-Kahf, Ya-Sin, and Al-Fatihah. Inspired by Surah Yusuf 12:4 — eleven stars."
      }
    }
  ]
}
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&family=Lateef:wght@400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/thin/style.css">
<script type="importmap">
{"imports":{"three":"https://esm.sh/three@0.170.0","three/addons/":"https://esm.sh/three@0.170.0/examples/jsm/"}}
</script>
<script>
// Instant dark screen if opening in clock mode — prevents landing page flash
if(location.hash==='#clock'){document.documentElement.classList.add('clock-direct');document.documentElement.style.cssText='background:#585860;overflow:hidden';}
</script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f8f7f4;--bg-alt:#f0efe9;--text:#1a1a1a;--text-muted:#6b6b6b;
  --gold:#c8a44e;--border:#e5e3dd;
  --font:'Inter',system-ui,-apple-system,sans-serif;
  --clock-size:min(480px,85vw);
}
html{font-size:16px}
body{
  font-family:var(--font);background:var(--bg);color:var(--text);
  font-weight:300;line-height:1.6;-webkit-font-smoothing:antialiased;
  overflow-x:clip;width:100%;
  transition:background 1s ease,color 1s ease;
}

/* ── Sticky clock ── */
.clock-sticky{
  position:sticky;top:0;z-index:50;
  display:flex;align-items:center;justify-content:center;
  height:calc(var(--clock-size) + 4.5rem);
  padding:4rem 0 .5rem;
  background:var(--bg);
  transition:background 1s ease;
}
#dialHero{
  width:var(--clock-size);height:var(--clock-size);
  border-radius:50%;overflow:hidden;
  background:#585860;
  flex-shrink:0;
  transition:box-shadow 1.5s ease;
}

/* ── Nav ── */
nav{
  position:fixed;top:0;left:0;right:0;z-index:100;
  padding:.75rem 1.5rem;display:flex;align-items:center;justify-content:space-between;
  transition:background .3s,box-shadow .3s;
}
nav.scrolled{background:var(--bg);opacity:.97;backdrop-filter:blur(12px);box-shadow:0 1px 0 var(--border)}
.nav-logo{font-weight:500;font-size:.9rem;letter-spacing:.02em}

/* ── Buttons ── */
.btn{
  display:inline-flex;align-items:center;gap:.5rem;
  padding:.65rem 1.5rem;border-radius:100px;
  font-family:var(--font);font-size:.875rem;font-weight:500;
  cursor:pointer;border:none;transition:all .2s;
}
.btn-primary{background:var(--text);color:var(--bg)}
.btn-primary:hover{opacity:.85}
.btn-outline{
  background:transparent;border:1px solid var(--border);color:var(--text);
  transition:color .5s ease,background-color .5s ease,border-color .5s ease;
}
.btn-outline:hover{border-color:var(--text)}
a{color:inherit;text-decoration:none}

/* ── Sections ── */
.scroll-section{
  min-height:80vh;
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  text-align:center;
  padding:0 2rem 6rem;
  position:relative;
  transition:background 1s ease,color 1s ease;
}
.section-label{
  font-weight:500;font-size:.7rem;letter-spacing:.15em;
  text-transform:uppercase;color:var(--gold);margin-bottom:1rem;
}
.section-title{
  font-weight:200;font-size:clamp(2rem,5vw,3.5rem);
  line-height:1.15;letter-spacing:-.02em;margin-bottom:1.25rem;
  transition:color 1s ease;
}
.section-body{
  font-weight:200;font-size:1.05rem;line-height:1.7;
  color:var(--text-muted);max-width:480px;margin:0 auto;
  transition:color 1s ease;
}

/* ── Quran verse block ── */
.verse{text-align:center;margin-top:2rem;max-width:560px}
.verse-ar{
  font-family:'Lateef','Traditional Arabic',serif;
  font-size:clamp(1.5rem,3.5vw,2.2rem);line-height:2;
  direction:rtl;color:var(--text);margin-bottom:1rem;
  transition:color 1s ease;
}
.verse-en{
  font-size:1rem;font-weight:300;color:var(--text-muted);
  font-style:italic;line-height:1.7;margin-bottom:.5rem;
  transition:color 1s ease;
}
.verse-ref{
  font-size:.8rem;font-weight:500;letter-spacing:.08em;
  color:var(--text-muted);margin-bottom:1rem;
  transition:color 1s ease;
}

/* ── Reveal animation ── */
.reveal{opacity:0;transform:translateY(30px);transition:opacity .8s ease,transform .8s ease}
.reveal.visible{opacity:1;transform:none}
@media(prefers-reduced-motion:reduce){.reveal{opacity:1;transform:none;transition:none}}

/* ── Prayer card ── */
#prayerCard{
  width:100%;max-width:360px;
  background:#fff;border:1px solid var(--border);
  padding:1.75rem;display:flex;flex-direction:column;gap:.5rem;
  font-family:var(--font);margin-top:2rem;
  transition:background 1s ease,border-color 1s ease,color 1s ease;
}

/* ── Dial picker ── */
.dial-dots{display:flex;gap:6px;justify-content:center;margin-top:1rem;flex-wrap:wrap}
.dial-dot{
  width:8px;height:8px;border-radius:50%;border:none;
  cursor:pointer;padding:0;transition:opacity .3s,transform .3s;
  opacity:.2;background:var(--text);
}
.dial-dot.active{opacity:.7;transform:scale(1.3)}

/* ── Install steps ── */
.steps{display:flex;gap:2rem;margin-top:2.5rem;justify-content:center;flex-wrap:wrap;max-width:100%}
.step{text-align:center;min-width:0;width:200px;flex-shrink:1}
.step-icon{font-size:2.5rem;color:var(--text-muted);margin-bottom:.75rem;transition:color 1s ease}
.step-num{font-weight:500;font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:var(--gold);margin-bottom:.4rem}
.step h3{font-weight:400;font-size:1rem;margin-bottom:.4rem;transition:color 1s ease}
.step p{font-weight:300;font-size:.875rem;color:var(--text-muted);line-height:1.5;transition:color 1s ease}

/* ── Scroll Snap ── */
html{scroll-snap-type:y mandatory;scroll-padding-top:calc(var(--clock-size) + 4.5rem)}
.scroll-section{scroll-snap-align:start}

/* ── Footer ── */
footer{
  padding:3rem 2rem;text-align:center;border-top:1px solid var(--border);
  transition:border-color 1s ease;
}
footer p{font-weight:300;font-size:.85rem;color:var(--text-muted);transition:color 1s ease}
footer a{transition:color .2s}
footer a:hover{color:var(--text)}
.footer-sep{margin:0 .75rem;opacity:.4}

/* ── Adhan button ── */
.adhan-btn{
  margin-top:1.5rem;padding:.75rem 2rem;font-size:1rem;gap:.75rem;
}

@media(max-width:768px){
  .scroll-section{padding:1.5rem 1.5rem 4rem;min-height:60vh}
}
@media(min-width:769px){
  :root{--clock-size:min(500px,45vw)}
  .scroll-section{max-width:700px;margin:0 auto}
  .section-body{max-width:520px}
  footer{max-width:700px;margin:0 auto}
}
@media(min-width:1200px){
  :root{--clock-size:min(560px,35vw)}
  .scroll-section{max-width:800px}
}

/* ── Fullscreen Clock Overlay ── */
.clock-fs-overlay{position:fixed;inset:0;z-index:200;background:#585860;display:none;flex-direction:column;align-items:center;justify-content:center}
.clock-fs-overlay.active{display:flex}
/* Hide landing page content instantly when loading #clock */
html.clock-direct nav,.clock-direct .scroll-section,.clock-direct .clock-sticky,.clock-direct footer{display:none!important}
.clock-fs-overlay canvas{width:100%!important;height:100%!important;position:absolute;inset:0}
.clock-fs-close{position:fixed;top:calc(env(safe-area-inset-top,12px) + 12px);left:16px;z-index:210;background:none;border:none;color:rgba(255,255,255,.6);font-size:1.5rem;cursor:pointer;padding:8px}
.fs-prayer-bar{position:fixed;top:calc(env(safe-area-inset-top,12px) + 14px);left:16px;right:56px;font-family:var(--font);font-size:.65rem;font-weight:300;letter-spacing:.12em;text-align:left;z-index:210;pointer-events:none;color:rgba(255,255,255,.55)}
.fs-mode-toggle{position:fixed;top:calc(env(safe-area-inset-top,12px) + 12px);right:16px;z-index:210;cursor:pointer;background:none;border:none;padding:8px;color:rgba(255,255,255,.6)}
.fs-mode-toggle svg{width:20px;height:20px;stroke-width:1;fill:none;stroke:currentColor}
.fs-info{position:fixed;bottom:env(safe-area-inset-bottom,12px);left:0;right:0;text-align:center;font-family:var(--font);pointer-events:none;z-index:210;padding:0 16px 16px;color:rgba(255,255,255,.7)}
.fs-info .hijri{font-size:.8rem;font-weight:300;letter-spacing:.04em}
.fs-info .greg{font-size:.7rem;font-weight:200;margin-top:3px;opacity:.6}
.fs-dial-bar{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 52px);left:0;right:0;display:flex;justify-content:center;gap:7px;z-index:210;pointer-events:auto}
.fs-dial-info{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);left:0;right:0;text-align:center;font-family:var(--font);z-index:210;pointer-events:auto;color:rgba(255,255,255,.7)}
#fsDialName{font-size:.7rem;font-weight:500;letter-spacing:.15em;text-transform:uppercase;opacity:.7}
#fsDialSurah{font-size:.75rem;font-weight:200;letter-spacing:.04em;opacity:.5;display:inline}
.fs-listen-btn{background:none;border:none;padding:3px 8px;cursor:pointer;opacity:.4;transition:opacity .2s;vertical-align:middle;color:rgba(255,255,255,.6)}
.fs-listen-btn:hover{opacity:.8}
.fs-dial-bar .dial-dot{width:6px;height:6px;border-radius:50%;border:1.5px solid rgba(255,255,255,.25);cursor:pointer;transition:all .3s;background:none;padding:0}
.fs-dial-bar .dial-dot.active{border-color:rgba(255,255,255,.7);background:rgba(255,255,255,.4)}
</style>
</head>
<body>

<!-- Fullscreen Clock Overlay -->
<div id="clockFullscreen" class="clock-fs-overlay">
  <button id="clockFsClose" class="clock-fs-close" aria-label="Close">&times;</button>
  <div id="fsPrayerBar" class="fs-prayer-bar"><span id="fsPrayerTimes"></span></div>
  <button id="fsModeToggle" class="fs-mode-toggle" aria-label="Toggle day/night"><svg id="fsModeIcon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button>
  <div id="fsInfo" class="fs-info"><div class="hijri" id="fsHijri"></div><div class="greg" id="fsGreg"></div></div>
  <div id="fsDialBar" class="fs-dial-bar"></div>
  <div id="fsDialInfo" class="fs-dial-info"><span id="fsDialName"></span><br><span id="fsDialSurah"></span><button id="fsListenBtn" class="fs-listen-btn" aria-label="Listen to surah"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="5,3 19,12 5,21"/></svg></button></div>
</div>

<!-- Nav -->
<nav>
  <div class="nav-logo">A Gift of Time</div>
  <a href="#" class="btn btn-primary" style="font-size:.8rem;padding:.55rem 1.25rem" onclick="openClockFullscreen();return false;">Open Clock</a>
</nav>

<!-- Sticky Clock -->
<div class="clock-sticky">
  <div id="dialHero"></div>
</div>

<!-- 1. THE HOOK -->
<section class="scroll-section" id="sec-hook">
  <div class="reveal">
    <p class="section-label">Introducing</p>
    <h1 class="section-title" style="font-size:clamp(2.5rem,7vw,5rem);letter-spacing:-.03em">A Gift of Time.</h1>
    <p class="section-body">A prayer-aware clock for your family. Crafted with intention, rooted in the Quran.</p>
    <a href="support.html" class="btn btn-outline" style="margin-top:1rem"><i class="ph-thin ph-heart"></i> Support this project</a>
  </div>
</section>

<!-- 2. QIBLA -->
<section class="scroll-section" id="sec-qibla">
  <div class="reveal">
    <p class="section-label">Direction</p>
    <h2 class="section-title">Always facing Qibla.</h2>
    <p class="section-body">The subdial compass finds the direction of al-Masjid al-Haram. Turn your phone, and it turns with you.</p>
    <div class="verse">
      <p class="verse-ar">فَوَلِّ وَجْهَكَ شَطْرَ ٱلْمَسْجِدِ ٱلْحَرَامِ</p>
      <p class="verse-en">"So turn your face toward al-Masjid al-Haram."</p>
      <p class="verse-ref">Al-Baqarah 2:144</p>
      <button onclick="playVerse(this,'https://cdn.islamic.network/quran/audio/128/ar.alafasy/151.mp3')" class="btn btn-outline" style="font-size:.85rem;padding:.6rem 1.25rem"><i class="ph-thin ph-play"></i> Listen</button>
    </div>
  </div>
</section>

<!-- 3. PRAYER TIMES -->
<section class="scroll-section" id="sec-prayer">
  <div class="reveal">
    <p class="section-label">Prayer Times</p>
    <h2 class="section-title">Every salah, right on time.</h2>
    <p class="section-body">Automatic prayer times for your location. From Fajr to Isha, never miss a moment.</p>
    <div id="prayerCard">
      <p style="font-size:.7rem;font-weight:500;letter-spacing:.12em;text-transform:uppercase;color:var(--text-muted)" id="pcHijri">Loading...</p>
      <p style="font-size:.8rem;font-weight:300;color:var(--text-muted)" id="pcGreg"></p>
      <p style="font-size:.7rem;font-weight:400;color:var(--text-muted);margin-bottom:.25rem" id="pcLoc"></p>
      <div id="pcTimes" style="display:flex;flex-direction:column;gap:.4rem;width:100%"></div>
      <p style="font-size:.75rem;font-weight:300;color:var(--gold);margin-top:.25rem" id="pcNext"></p>
    </div>
    <div class="verse">
      <p class="verse-ar">إِنَّ ٱلصَّلَوٰةَ كَانَتْ عَلَى ٱلْمُؤْمِنِينَ كِتَـٰبًا مَّوْقُوتًا</p>
      <p class="verse-en">"Indeed, prayer has been decreed upon the believers at specified times."</p>
      <p class="verse-ref">An-Nisa 4:103</p>
      <button onclick="playVerse(this,'https://cdn.islamic.network/quran/audio/128/ar.alafasy/574.mp3')" class="btn btn-outline" style="font-size:.85rem;padding:.6rem 1.25rem"><i class="ph-thin ph-play"></i> Listen</button>
    </div>
  </div>
</section>

<!-- 4. ELEVEN DIALS -->
<section class="scroll-section" id="sec-dials">
  <div class="reveal">
    <p class="section-label">Dial Themes</p>
    <h2 class="section-title">Eleven stars, eleven dials.</h2>
    <p class="section-body">Each dial is named for a Surah of the Holy Quran — chosen to inspire reflection on mercy, creation, and time.</p>
    <div style="margin-top:1.5rem;display:flex;align-items:center;gap:1.5rem">
      <button onclick="dialPrev()" aria-label="Previous" style="background:none;border:none;cursor:pointer;padding:.5rem"><i class="ph-thin ph-caret-left" style="font-size:1.5rem;color:var(--text);opacity:.3"></i></button>
      <div style="text-align:center;min-width:200px">
        <span id="dialLabel" style="font-weight:400;font-size:.95rem;letter-spacing:.04em">Al-Layl</span>
        <div class="dial-dots" id="dialDots"></div>
      </div>
      <button onclick="dialNext()" aria-label="Next" style="background:none;border:none;cursor:pointer;padding:.5rem"><i class="ph-thin ph-caret-right" style="font-size:1.5rem;color:var(--text);opacity:.3"></i></button>
    </div>
    <button id="dialListen" onclick="playDialSurah()" class="btn btn-outline" style="font-size:.8rem;padding:.5rem 1rem;gap:.4rem;margin-top:1rem"><i class="ph-thin ph-play"></i> Listen to this Surah</button>
    <div class="verse" style="margin-top:2.5rem">
      <p class="verse-ar">إِذْ قَالَ يُوسُفُ لِأَبِيهِ يَـٰٓأَبَتِ إِنِّىٓ رَأَيْتُ أَحَدَ عَشَرَ كَوْكَبًا وَٱلشَّمْسَ وَٱلْقَمَرَ رَأَيْتُهُمْ لِى سَـٰجِدِينَ</p>
      <p class="verse-en">"When Joseph said to his father, 'O my father, indeed I have seen eleven stars and the sun and the moon; I saw them prostrating to me.'"</p>
      <p class="verse-ref">Yusuf 12:4</p>
      <button onclick="playVerse(this,'https://cdn.islamic.network/quran/audio/128/ar.alafasy/1378.mp3')" class="btn btn-outline" style="font-size:.85rem;padding:.6rem 1.25rem"><i class="ph-thin ph-play"></i> Listen</button>
    </div>
  </div>
</section>

<!-- 5. NIGHT MODE -->
<section class="scroll-section" id="sec-night">
  <div class="reveal">
    <p class="section-label">Night Mode</p>
    <h2 class="section-title">The lume reveals itself.</h2>
    <p class="section-body">As darkness falls, SuperLuminova indices glow to life. Each dial has its own lume colour — a quiet constellation on your wrist.</p>
    <div class="verse">
      <p class="verse-ar">وَجَعَلَ ٱلظُّلُمَـٰتِ وَٱلنُّورَ</p>
      <p class="verse-en">"And He made darknesses and light."</p>
      <p class="verse-ref">Al-An'am 6:1</p>
      <button onclick="playVerse(this,'https://cdn.islamic.network/quran/audio/128/ar.alafasy/728.mp3')" class="btn btn-outline" style="font-size:.85rem;padding:.6rem 1.25rem"><i class="ph-thin ph-play"></i> Listen</button>
    </div>
  </div>
</section>

<!-- 6. ADHAN -->
<section class="scroll-section" id="sec-adhan">
  <div class="reveal">
    <p class="section-label">Adhan</p>
    <h2 class="section-title">Hear the call to prayer.</h2>
    <p class="section-body">Mishary Rashid al-Afasy's voice, spatialized toward Qibla. The sound comes from the direction of Mecca.</p>
    <button id="adhanBtn" onclick="playAdhan(this)" class="btn btn-outline adhan-btn"><i class="ph-thin ph-play"></i> Play Spatial Adhan</button>
    <p style="font-size:.7rem;color:var(--text-muted);margin-top:.75rem;font-weight:300;opacity:.6">Best with headphones — sound moves toward Mecca as you turn</p>
  </div>
</section>

<!-- 7. INSTALL -->
<section class="scroll-section" id="sec-install">
  <div class="reveal">
    <p class="section-label">Install</p>
    <h2 class="section-title">Add to your home screen.</h2>
    <div class="steps">
      <div class="step">
        <i class="ph-thin ph-globe step-icon"></i>
        <p class="step-num">Step 1</p>
        <h3>Open in Safari</h3>
        <p>Visit the clock in your mobile browser.</p>
      </div>
      <div class="step">
        <i class="ph-thin ph-share-network step-icon"></i>
        <p class="step-num">Step 2</p>
        <h3>Tap Share</h3>
        <p>Select "Add to Home Screen."</p>
      </div>
      <div class="step">
        <i class="ph-thin ph-house step-icon"></i>
        <p class="step-num">Step 3</p>
        <h3>Launch anytime</h3>
        <p>Opens full-screen, like a native app.</p>
      </div>
    </div>
    <a href="#" class="btn btn-primary" style="margin-top:3rem" onclick="openClockFullscreen();return false;">Open Clock</a>
  </div>
</section>

<!-- Footer -->
<footer>
  <p style="margin-bottom:.5rem">By <a href="https://tawfeeqmartin.com" target="_blank" rel="noopener">Tawfeeq Martin</a></p>
  <p><a href="support.html">Support</a><span class="footer-sep">·</span><a href="mailto:feedback@agiftoftime.app">Feedback</a><span class="footer-sep">·</span><a href="privacy.html">Privacy & Terms</a></p>
</footer>

<script>
// ══════════════════════════════════════════
// DIAL DATA
// ══════════════════════════════════════════
const DIALS=['tennis','white','salmon','slate','sky','kawthar','dhuha','najm','qamar','ward','lilas'];
const DIAL_NAMES={'tennis':'Ar-Raḥmān','white':'An-Nūr','salmon':'Ash-Shams','slate':'Al-Layl','sky':'Al-Burūj','kawthar':'Al-Kawthar','dhuha':'Aḍ-Ḍuḥā','najm':'An-Najm','qamar':'Al-Qamar','ward':'Al-Wāqiʿah','lilas':'Al-Mulk'};
const DIAL_COLORS={'tennis':'#68b890','white':'#e8e4dc','salmon':'#d8988c','slate':'#585860','sky':'#82b8d8','kawthar':'#f2dce0','dhuha':'#f08040','najm':'#384870','qamar':'#c0c4cc','ward':'#d89098','lilas':'#8878a8'};
const DIAL_LUMES={'tennis':'#88ff30','white':'#ffa0c0','salmon':'#ffc070','slate':'#c8e8a0','sky':'#80d0ff','kawthar':'#ffa0c0','dhuha':'#ffc040','najm':'#90b8ff','qamar':'#e8f0ff','ward':'#ff80a8','lilas':'#c090ff'};
const DIAL_SURAHS={'tennis':55,'white':24,'salmon':91,'slate':92,'sky':85,'kawthar':108,'dhuha':93,'najm':53,'qamar':54,'ward':56,'lilas':67};

let dialIdx=3; // slate default
let pageNight=false;
let dialAudio=null, dialPlaying=false;
let adhanAudio=null;
let dialCycleTimer=null;

// ══════════════════════════════════════════
// VERSE AUDIO HELPER
// ══════════════════════════════════════════
function playVerse(btn,url){
  if(!btn._a){
    btn._a=new Audio(url);
    btn._a.onended=()=>{btn.innerHTML='<i class="ph-thin ph-play"></i> Listen'};
  }
  if(btn._a.paused){btn._a.play();btn.innerHTML='<i class="ph-thin ph-pause"></i> Playing'}
  else{btn._a.pause();btn.innerHTML='<i class="ph-thin ph-play"></i> Listen'}
}

// ══════════════════════════════════════════
// DIAL CONTROLS
// ══════════════════════════════════════════
function buildDots(){
  const c=document.getElementById('dialDots');
  c.innerHTML=DIALS.map((_,i)=>`<button class="dial-dot${i===dialIdx?' active':''}" onclick="switchDial(${i})" style="background:${DIAL_COLORS[DIALS[i]]}" aria-label="${DIAL_NAMES[DIALS[i]]}"></button>`).join('');
}
function switchDial(i){
  dialIdx=i;
  updateDial();
}
function updateDial(){
  const d=DIALS[dialIdx];
  document.getElementById('dialLabel').textContent=DIAL_NAMES[d];
  document.querySelectorAll('.dial-dot').forEach((dot,i)=>{
    dot.classList.toggle('active',i===dialIdx);
  });
  if(dialAudio&&!dialAudio.paused){dialAudio.pause();dialPlaying=false;}
  document.getElementById('dialListen').innerHTML='<i class="ph-thin ph-play"></i> Listen to this Surah';
  if(window._clockSwitchDial) window._clockSwitchDial(d);
  updateLumeHalo();
}
function dialNext(){dialIdx=(dialIdx+1)%DIALS.length;updateDial();}
function dialPrev(){dialIdx=(dialIdx-1+DIALS.length)%DIALS.length;updateDial();}

function updateLumeHalo(){
  const hero=document.getElementById('dialHero');
  if(pageNight){
    const lume=DIAL_LUMES[DIALS[dialIdx]]||'#c8e8a0';
    hero.style.boxShadow='0 0 60px '+lume+'50, 0 0 120px '+lume+'25';
  }else{
    hero.style.boxShadow='none';
  }
}

function playDialSurah(){
  const num=DIAL_SURAHS[DIALS[dialIdx]];
  if(!num)return;
  const btn=document.getElementById('dialListen');
  if(dialPlaying&&dialAudio&&!dialAudio.paused){
    dialAudio.pause();dialPlaying=false;
    btn.innerHTML='<i class="ph-thin ph-play"></i> Listen to this Surah';return;
  }
  dialPlaying=true;
  dialAudio=new Audio('https://download.quranicaudio.com/qdc/mishari_al_afasy/murattal/'+num+'.mp3');
  dialAudio.onended=()=>{dialPlaying=false;btn.innerHTML='<i class="ph-thin ph-play"></i> Listen to this Surah'};
  dialAudio.play().catch(()=>{});
  btn.innerHTML='<i class="ph-thin ph-pause"></i> Playing — al-Afasy';
}

// ══════════════════════════════════════════
// NIGHT MODE
// ══════════════════════════════════════════
function setNightMode(on){
  if(pageNight===on)return;
  pageNight=on;
  const r=document.documentElement;
  if(on){
    r.style.setProperty('--bg','#0c0c12');
    r.style.setProperty('--bg-alt','#111114');
    r.style.setProperty('--text','#e8e4dc');
    r.style.setProperty('--text-muted','#8a8a8a');
    r.style.setProperty('--border','rgba(255,255,255,.08)');
  }else{
    r.style.setProperty('--bg','#f8f7f4');
    r.style.setProperty('--bg-alt','#f0efe9');
    r.style.setProperty('--text','#1a1a1a');
    r.style.setProperty('--text-muted','#6b6b6b');
    r.style.setProperty('--border','#e5e3dd');
  }
  document.querySelector('.clock-sticky').style.background=on?'#0c0c12':'var(--bg)';
  const pc=document.getElementById('prayerCard');
  if(pc){pc.style.background=on?'#141418':'#fff';pc.style.borderColor=on?'rgba(255,255,255,.08)':'var(--border)';}
  if(window._clockSetNight) window._clockSetNight(on);
  updateLumeHalo();
}

// ══════════════════════════════════════════
// SPATIAL ADHAN (HRTF toward Qibla)
// ══════════════════════════════════════════
let adhanCtx=null, adhanBufSrc=null, adhanPanner=null, adhanGain=null;
let adhanDecodedBuf=null, adhanInterval=null;
let adhanDeviceHeading=0, adhanQiblaAngle=0, adhanCurrentPan=0;
let adhanHasCompass=false;

// Get Qibla bearing from user location
async function adhanGetQibla(){
  try{
    const pos=await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j,{maximumAge:300000,timeout:5000}));
    const lat=pos.coords.latitude*Math.PI/180, lng=pos.coords.longitude*Math.PI/180;
    const mLat=21.4225*Math.PI/180, mLng=39.8262*Math.PI/180;
    adhanQiblaAngle=Math.atan2(Math.sin(mLng-lng),Math.cos(lat)*Math.tan(mLat)-Math.sin(lat)*Math.cos(mLng-lng));
  }catch(e){}
}

// Track device compass
function adhanCompassHandler(e){
  const h=e.webkitCompassHeading||e.alpha;
  if(h==null)return;
  adhanHasCompass=true;
  adhanDeviceHeading=h*Math.PI/180;
}

function updateAdhanPan(){
  if(!adhanPanner||!adhanHasCompass)return;
  const ra=adhanQiblaAngle-adhanDeviceHeading;
  const target=Math.max(-1,Math.min(1,Math.sin(ra)));
  adhanCurrentPan+=(target-adhanCurrentPan)*0.15;
  adhanPanner.pan.value=adhanCurrentPan;
}

async function playAdhan(btn){
  // Stop if playing
  if(adhanBufSrc){
    try{adhanBufSrc.stop();}catch(e){}
    adhanBufSrc=null;
    if(adhanInterval){clearInterval(adhanInterval);adhanInterval=null;}
    btn.innerHTML='<i class="ph-thin ph-play"></i> Play Spatial Adhan';
    return;
  }
  // Also stop plain audio if it was playing
  if(adhanAudio&&!adhanAudio.paused){adhanAudio.pause();adhanAudio=null;}

  btn.innerHTML='<i class="ph-thin ph-circle-notch"></i> Loading...';

  // Request compass permission (iOS)
  if(typeof DeviceOrientationEvent!=='undefined'&&DeviceOrientationEvent.requestPermission){
    try{await DeviceOrientationEvent.requestPermission();}catch(e){}
  }
  window.addEventListener('deviceorientation',adhanCompassHandler);

  // Get Qibla direction
  await adhanGetQibla();

  // Create audio context + decode
  if(!adhanCtx) adhanCtx=new(window.AudioContext||window.webkitAudioContext)();
  await adhanCtx.resume();

  if(!adhanDecodedBuf){
    try{
      const r=await fetch('https://cookmom.github.io/ramadan-clock/audio/adhan-mishari.mp3');
      const ab=await r.arrayBuffer();
      adhanDecodedBuf=await adhanCtx.decodeAudioData(ab);
    }catch(e){
      btn.innerHTML='<i class="ph-thin ph-play"></i> Play Spatial Adhan';
      return;
    }
  }

  // Play through StereoPanner toward Qibla
  adhanBufSrc=adhanCtx.createBufferSource();
  adhanBufSrc.buffer=adhanDecodedBuf;
  adhanPanner=adhanCtx.createStereoPanner();
  adhanGain=adhanCtx.createGain();
  adhanGain.gain.value=1.0;
  adhanBufSrc.connect(adhanGain).connect(adhanPanner).connect(adhanCtx.destination);

  updateAdhanPan();
  adhanInterval=setInterval(updateAdhanPan,100);

  adhanBufSrc.start(0);
  adhanBufSrc.onended=()=>{
    adhanBufSrc=null;
    if(adhanInterval){clearInterval(adhanInterval);adhanInterval=null;}
    btn.innerHTML='<i class="ph-thin ph-play"></i> Play Spatial Adhan';
  };

  btn.innerHTML=adhanHasCompass
    ?'<i class="ph-thin ph-pause"></i> Playing toward Qibla — turn your phone'
    :'<i class="ph-thin ph-pause"></i> Playing — al-Afasy';
}

// ══════════════════════════════════════════
// SCROLL OBSERVERS
// ══════════════════════════════════════════
function setupScrollObservers(){
  const opts={threshold:0.4};

  // Section → clock state mapping
  const observe=(id,fn)=>{
    const el=document.getElementById(id);
    if(!el)return;
    new IntersectionObserver((entries)=>{
      if(entries[0].isIntersecting) fn();
    },opts).observe(el);
  };

  // Hook: slate, day
  observe('sec-hook',()=>{
    if(window._clockSwitchDial&&DIALS[dialIdx]!=='slate'){dialIdx=3;updateDial();}
    setNightMode(false);
  });

  // Qibla: keep slate, day
  observe('sec-qibla',()=>{
    setNightMode(false);
    if(window._clockQiblaDemo) window._clockQiblaDemo(true);
  });

  // Prayer: keep current, day — stop qibla demo
  observe('sec-prayer',()=>{
    setNightMode(false);
    if(window._clockQiblaDemo) window._clockQiblaDemo(false);
  });

  // Dials: start cycling
  observe('sec-dials',()=>{
    setNightMode(false);
    startDialCycle();
  });

  // Night: activate night mode
  observe('sec-night',()=>{
    setNightMode(true);
  });

  // Adhan: keep night
  observe('sec-adhan',()=>{
    setNightMode(true);
  });

  // Install: back to day
  observe('sec-install',()=>{
    setNightMode(false);
  });

  // Stop dial cycle when leaving dials section
  new IntersectionObserver((entries)=>{
    if(!entries[0].isIntersecting) stopDialCycle();
  },{threshold:0.1}).observe(document.getElementById('sec-dials'));
}

function startDialCycle(){
  if(dialCycleTimer)return;
  dialCycleTimer=setInterval(()=>{dialNext()},2500);
}
function stopDialCycle(){
  if(dialCycleTimer){clearInterval(dialCycleTimer);dialCycleTimer=null;}
}

// ══════════════════════════════════════════
// REVEAL OBSERVER
// ══════════════════════════════════════════
const revealObs=new IntersectionObserver((entries)=>{
  entries.forEach(e=>{if(e.isIntersecting){e.target.classList.add('visible');revealObs.unobserve(e.target)}});
},{threshold:0.1,rootMargin:'0px 0px -40px 0px'});

// ══════════════════════════════════════════
// NAV SCROLL
// ══════════════════════════════════════════
const nav=document.querySelector('nav');
window.addEventListener('scroll',()=>{nav.classList.toggle('scrolled',window.scrollY>40)},{passive:true});

// ══════════════════════════════════════════
// PRAYER TIMES
// ══════════════════════════════════════════
(async()=>{
  let city='Los Angeles',country='US',apiUrl;
  try{
    const pos=await new Promise((r,j)=>navigator.geolocation?navigator.geolocation.getCurrentPosition(r,j,{maximumAge:300000,timeout:3000}):j());
    const lat=pos.coords.latitude,lon=pos.coords.longitude;
    apiUrl=`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=2`;
    try{const geoR=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
    const geo=await geoR.json();
    city=geo.address?.city||geo.address?.town||geo.address?.village||city;
    country=geo.address?.country_code?.toUpperCase()||country;}catch(e){}
  }catch(e){
    try{const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
    city=tz.split('/').pop().replace(/_/g,' ');}catch(e2){}
    apiUrl=`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=US&method=2`;
  }
  try{
    const r=await fetch(apiUrl);const j=await r.json();if(j.code!==200)return;
    const t=j.data.timings,d=j.data.date;
    document.getElementById('pcHijri').textContent=`${d.hijri.day} ${d.hijri.month.en} ${d.hijri.year} AH`;
    document.getElementById('pcGreg').textContent=`${d.gregorian.weekday.en}, ${d.gregorian.day} ${d.gregorian.month.en} ${d.gregorian.year}`;
    document.getElementById('pcLoc').textContent=`${city}${country?' · '+country:''}`;
    const prayers=['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'];
    const colors={Fajr:'#5b7fa5',Sunrise:'#e6a23c',Dhuhr:'#c8a44e',Asr:'#d4845e',Maghrib:'#c0392b',Isha:'#6366f1'};
    const now=new Date();const nowM=now.getHours()*60+now.getMinutes();
    const toMin=s=>{const[h,m]=s.split(':').map(Number);return h*60+m;};
    const to12=s=>{const[h,m]=s.split(':');const hr=parseInt(h);return(hr%12||12)+':'+m+(hr>=12?' PM':' AM');};
    let nextP='';
    prayers.forEach(p=>{const pm=toMin(t[p]);if(!nextP&&pm>nowM)nextP=p;});
    document.getElementById('pcTimes').innerHTML=prayers.map(p=>{
      const isNext=p===nextP;
      return`<div style="display:flex;justify-content:space-between;align-items:center;padding:.35rem 0;${isNext?'font-weight:500;':'font-weight:300;color:var(--text-muted);'}">
        <span style="display:flex;align-items:center;gap:.5rem"><span style="width:6px;height:6px;border-radius:50%;background:${colors[p]};display:inline-block"></span>${p}</span>
        <span style="font-variant-numeric:tabular-nums;font-size:.9rem">${to12(t[p])}</span></div>`;
    }).join('');
    if(nextP)document.getElementById('pcNext').textContent=`Next: ${nextP} at ${to12(t[nextP])}`;
  }catch(e){document.getElementById('pcHijri').textContent='Prayer times unavailable';}
})();

// ══════════════════════════════════════════
// INIT
// ══════════════════════════════════════════
buildDots();
document.querySelectorAll('.reveal').forEach(el=>revealObs.observe(el));

// Touch swipe on dial hero + fullscreen overlay
function addSwipe(el){
  let sx=0,locked=false;
  el.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;locked=false},{passive:true});
  el.addEventListener('touchmove',e=>{
    const dx=Math.abs(e.touches[0].clientX-sx);
    if(dx>10&&!locked){locked=true;e.preventDefault();}
  },{passive:false});
  el.addEventListener('touchend',e=>{
    const dx=e.changedTouches[0].clientX-sx;
    if(Math.abs(dx)>40){dx<0?dialNext():dialPrev();}
  },{passive:true});
}
addSwipe(document.getElementById('dialHero'));
addSwipe(document.getElementById('clockFullscreen'));

// Auto-open fullscreen if URL has #clock
if(location.hash === '#clock') {
  const _waitClock = setInterval(()=>{
    if(window._clockSetFullscreen && document.querySelector('#dialHero canvas') && typeof openClockFullscreen === 'function') {
      clearInterval(_waitClock);
      setTimeout(()=>openClockFullscreen(), 200);
    }
  }, 200);
  setTimeout(()=>clearInterval(_waitClock), 8000);
}

// Always start at top on refresh
history.scrollRestoration='manual';
window.scrollTo({top:0,behavior:'instant'});
document.documentElement.scrollTop=0;
document.body.scrollTop=0;
// Belt and suspenders — force again after snap settles
setTimeout(()=>{window.scrollTo({top:0,behavior:'instant'});},50);
setTimeout(()=>{window.scrollTo({top:0,behavior:'instant'});},200);
setTimeout(()=>{window.scrollTo({top:0,behavior:'instant'});},500);

// ══════════════════════════════════════════
// FULLSCREEN CLOCK
// ══════════════════════════════════════════
const FS_DIALS_DATA = [
  {name:'tennis',color:'#68b890'},{name:'white',color:'#e8e4dc'},{name:'salmon',color:'#d8988c'},
  {name:'slate',color:'#6a6a74'},{name:'sky',color:'#82b8d8'},{name:'kawthar',color:'#f2dce0'},
  {name:'dhuha',color:'#f08040'},{name:'najm',color:'#384870'},{name:'qamar',color:'#c0c4cc'},
  {name:'ward',color:'#d89098'},{name:'lilas',color:'#8878a8'}
];
const FS_SURAH_MAP = {tennis:55,white:24,salmon:91,slate:92,sky:85,kawthar:108,dhuha:93,najm:53,qamar:54,ward:56,lilas:67};
const FS_DIAL_NAMES_MAP = {tennis:'Ar-Raḥmān',white:'An-Nūr',salmon:'Ash-Shams',slate:'Al-Layl',sky:'Al-Burūj',kawthar:'Al-Kawthar',dhuha:'Aḍ-Ḍuḥā',najm:'An-Najm',qamar:'Al-Qamar',ward:'Al-Wāqiʿah',lilas:'Al-Mulk'};
let fsNight = false;
let fsSurahAudio = null;

const SUN_SVG='<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
const MOON_SVG='<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';

function buildFsDialDots() {
  const bar = document.getElementById('fsDialBar');
  bar.innerHTML = FS_DIALS_DATA.map(d =>
    `<button class="dial-dot${d.name===DIALS[dialIdx]?' active':''}" data-dial="${d.name}" style="border-color:${d.color}" onclick="fsSwitchDial('${d.name}')" aria-label="${FS_DIAL_NAMES_MAP[d.name]}"></button>`
  ).join('');
}

function fsSwitchDial(name) {
  if(window._clockSwitchDial) window._clockSwitchDial(name);
  // Update landing page state
  const idx = DIALS.indexOf(name);
  if(idx >= 0) { dialIdx = idx; updateDial(); }
  // Update fullscreen UI
  document.querySelectorAll('#fsDialBar .dial-dot').forEach(d => d.classList.toggle('active', d.dataset.dial === name));
  document.getElementById('fsDialName').textContent = name.charAt(0).toUpperCase() + name.slice(1);
  document.getElementById('fsDialSurah').textContent = FS_DIAL_NAMES_MAP[name] || '';
}

function fsUpdateModeIcon() {
  document.getElementById('fsModeIcon').innerHTML = fsNight ? SUN_SVG : MOON_SVG;
}

async function fsFetchPrayer() {
  try {
    const pos = await new Promise((r,j) => navigator.geolocation ? navigator.geolocation.getCurrentPosition(r,j,{maximumAge:300000,timeout:3000}) : j());
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=2`);
    const j = await res.json();
    if(j.code===200) {
      const t = j.data.timings;
      document.getElementById('fsPrayerTimes').textContent = `Fajr ${t.Fajr} · Dhuhr ${t.Dhuhr} · Asr ${t.Asr} · Maghrib ${t.Maghrib} · Isha ${t.Isha}`;
      document.getElementById('fsHijri').textContent = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
    }
  } catch(e) {
    try {
      const res = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=LosAngeles&country=US&method=2`);
      const j = await res.json();
      if(j.code===200) {
        const t = j.data.timings;
        document.getElementById('fsPrayerTimes').textContent = `Fajr ${t.Fajr} · Dhuhr ${t.Dhuhr} · Asr ${t.Asr} · Maghrib ${t.Maghrib} · Isha ${t.Isha}`;
        document.getElementById('fsHijri').textContent = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
      }
    } catch(e2) {}
  }
}

function openClockFullscreen() {
  const overlay = document.getElementById('clockFullscreen');
  const canvas = document.querySelector('#dialHero canvas');
  if(!canvas) return;

  // Stop tour/idle
  stopDialCycle();

  // Move canvas into overlay
  overlay.appendChild(canvas);
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
  document.querySelector('nav').style.display = 'none';

  // Tell clock engine to go fullscreen
  if(window._clockSetFullscreen) window._clockSetFullscreen(true);

  // Set night to match current page state
  fsNight = pageNight;
  fsUpdateModeIcon();

  // Build dial dots
  buildFsDialDots();
  const cur = DIALS[dialIdx];
  document.getElementById('fsDialName').textContent = cur.charAt(0).toUpperCase() + cur.slice(1);
  document.getElementById('fsDialSurah').textContent = DIAL_NAMES[cur] || '';

  // Fetch prayer times for fullscreen bar
  fsFetchPrayer();

  // Push history state for back button
  history.pushState({clockFs:true}, '', '#clock');
}

function closeClockFullscreen() {
  const overlay = document.getElementById('clockFullscreen');
  const canvas = overlay.querySelector('canvas');
  if(!canvas) return;

  // Move canvas back
  document.getElementById('dialHero').appendChild(canvas);
  overlay.classList.remove('active');
  document.body.style.overflow = '';
  document.querySelector('nav').style.display = '';

  // Tell clock engine to go back to contained
  if(window._clockSetFullscreen) window._clockSetFullscreen(false);

  // Restore landing page theme-color + show content
  const m=document.querySelector('meta[name="theme-color"]'); if(m) m.content='#f8f7f4';
  document.documentElement.classList.remove('clock-direct');
  document.documentElement.style.cssText='';

  // Stop any fullscreen surah audio
  if(fsSurahAudio && !fsSurahAudio.paused) { fsSurahAudio.pause(); fsSurahAudio = null; }
}

// Close button
document.getElementById('clockFsClose').addEventListener('click', () => {
  closeClockFullscreen();
  if(location.hash === '#clock') history.back();
});

// Back button
window.addEventListener('popstate', (e) => {
  if(document.getElementById('clockFullscreen').classList.contains('active')) {
    closeClockFullscreen();
  }
});

// Mode toggle in fullscreen
document.getElementById('fsModeToggle').addEventListener('click', () => {
  fsNight = !fsNight;
  fsUpdateModeIcon();
  if(window._clockSetNight) window._clockSetNight(fsNight);
  setNightMode(fsNight);
});

// Listen button in fullscreen
document.getElementById('fsListenBtn').addEventListener('click', () => {
  const cur = DIALS[dialIdx];
  const num = FS_SURAH_MAP[cur];
  if(!num) return;
  if(fsSurahAudio && !fsSurahAudio.paused) { fsSurahAudio.pause(); fsSurahAudio = null; return; }
  fsSurahAudio = new Audio(`https://download.quranicaudio.com/qdc/mishari_al_afasy/murattal/${num}.mp3`);
  fsSurahAudio.play().catch(()=>{});
});

// Load 3D clock immediately
window._clockContainer=document.getElementById('dialHero');
const _cs=document.createElement('script');
_cs.type='module';_cs.src='clock.js?v=20';
document.head.appendChild(_cs);

// ══════════════════════════════════════════
// SCROLL → CLOCK INDICATOR (scroll-position based, not IntersectionObserver)
// ══════════════════════════════════════════
setTimeout(()=>{
  const secIds=['sec-hook','sec-qibla','sec-prayer','sec-dials','sec-night','sec-adhan','sec-install'];
  const secEls=secIds.map(id=>document.getElementById(id)).filter(Boolean);
  // Offset = sticky clock height (clock-size + 5.5rem ≈ top of content area)
  let lastIdx=-1;
  function updateScrollIndicator(){
    const scrollTop=window.scrollY;
    // Find the last section whose top has scrolled past the clock bottom
    // Find which section is snapped — closest top to the snap line (just below clock)
    const snapLine=document.querySelector('.clock-sticky')?.getBoundingClientRect().bottom || 0;
    let activeIdx=0, bestDist=Infinity;
    for(let i=0;i<secEls.length;i++){
      const dist=Math.abs(secEls[i].getBoundingClientRect().top - snapLine);
      if(dist<bestDist){ bestDist=dist; activeIdx=i; }
    }
    if(activeIdx!==lastIdx){
      lastIdx=activeIdx;
      if(window._clockSetScrollSection) window._clockSetScrollSection(activeIdx);
    }
  }
  window.addEventListener('scroll',updateScrollIndicator,{passive:true});
  updateScrollIndicator(); // set initial
},600);

// Setup scroll observers after a brief delay to let clock init
setTimeout(setupScrollObservers,500);

// ══════════════════════════════════════════
// GUIDED TOUR — auto-scroll showroom mode
// ══════════════════════════════════════════
(function(){
  const TOUR_SECTIONS = [
    { id:'sec-hook',    dwell:5000 },
    { id:'sec-qibla',   dwell:7000 },
    { id:'sec-prayer',  dwell:8000 },
    { id:'sec-dials',   dwell:30000 }, // 11 dials × 2.5s + buffer
    { id:'sec-night',   dwell:7000 },
    { id:'sec-adhan',   dwell:8000 },  // linger, no auto-play
    { id:'sec-install', dwell:6000 },
  ];

  let tourIdx=0, tourTimer=null, tourActive=false, tourScrolling=false;
  let idleTimer=null;
  const IDLE_START=10000; // start tour after 10s idle

  function startTour(){
    if(tourActive) return;
    tourActive=true;
    tourIdx=0;
    // Disable scroll-snap so tour can scroll freely
    document.documentElement.style.scrollSnapType='none';
    // Request fullscreen on mobile for immersive demo
    try{
      const el=document.documentElement;
      if(el.requestFullscreen) el.requestFullscreen().catch(()=>{});
      else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    }catch(e){}
    advanceTour();
  }

  function stopTour(){
    tourActive=false;
    tourScrolling=false;
    if(tourTimer){clearTimeout(tourTimer);tourTimer=null;}
    if(idleTimer){clearTimeout(idleTimer);idleTimer=null;}
    // Re-enable scroll-snap
    document.documentElement.style.scrollSnapType='y mandatory';
    // Exit fullscreen
    try{if(document.fullscreenElement) document.exitFullscreen().catch(()=>{});}catch(e){}
  }

  function advanceTour(){
    if(!tourActive) return;
    if(tourIdx >= TOUR_SECTIONS.length){
      tourIdx=0;
      tourScrolling=true;
      window.scrollTo({top:0,behavior:'smooth'});
      setTimeout(()=>{tourScrolling=false;},1500);
      tourTimer=setTimeout(()=>advanceTour(), 2000);
      return;
    }
    const sec=TOUR_SECTIONS[tourIdx];
    const el=document.getElementById(sec.id);
    if(el){
      tourScrolling=true;
      el.scrollIntoView({behavior:'smooth',block:'start'});
      setTimeout(()=>{tourScrolling=false;},1500);
    }
    // Trigger section-specific actions
    if(sec.id==='sec-dials') startDialCycle();
    else stopDialCycle();
    if(sec.id==='sec-night') setNightMode(true);
    else if(sec.id==='sec-adhan') setNightMode(true);
    else setNightMode(false);
    // Qibla compass demo — only on direction section
    if(sec.id==='sec-qibla'&&window._clockQiblaDemo) window._clockQiblaDemo(true);
    else if(window._clockQiblaDemo) window._clockQiblaDemo(false);
    // Lock compass at noon during dial showcase
    if(sec.id==='sec-dials'&&window._clockLockCompass) window._clockLockCompass(true);
    else if(window._clockLockCompass) window._clockLockCompass(false);

    tourIdx++;
    tourTimer=setTimeout(()=>advanceTour(), sec.dwell);
  }

  function resetIdle(){
    if(idleTimer) clearTimeout(idleTimer);
    if(tourActive) stopTour();
    idleTimer=setTimeout(startTour, IDLE_START);
  }

  // User interaction pauses tour — touch/mouse/key only (scroll events unreliable with snap)
  ['touchstart','mousedown','wheel','keydown'].forEach(evt=>{
    window.addEventListener(evt,()=>{
      if(tourActive) stopTour();
      resetIdle();
    },{passive:true});
  });

  // Don't start idle timer until page is loaded and settled
  setTimeout(resetIdle, 3000);
})();
</script>
</body>
</html>
